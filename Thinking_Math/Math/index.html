<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MayÁöÑÂø´‰πêÂÖªËúÇÂú∫ (May's Bee Farm)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+SC:wght@400;700&display=swap');

        body {
            font-family: 'Fredoka', 'Noto Sans SC', sans-serif;
            background-color: #fefce8;
            /* Yellow-50 */
            /* Honeycomb background pattern */
            background-image: radial-gradient(#eab308 1.5px, transparent 1.5px), radial-gradient(#eab308 1.5px, #fefce8 1.5px);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            touch-action: manipulation;
            user-select: none;
        }

        /* --- Bee Styles --- */
        .block-one {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            z-index: 20;
        }

        .bee-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(1px 3px 2px rgba(0, 0, 0, 0.15));
            animation: buzz 2s infinite ease-in-out;
        }

        @keyframes buzz {

            0%,
            100% {
                transform: translateY(0) rotate(0);
            }

            25% {
                transform: translateY(-3px) rotate(-5deg);
            }

            75% {
                transform: translateY(3px) rotate(5deg);
            }
        }

        /* --- Beehive (Ten Block) --- */
        .block-ten {
            width: 60px;
            height: 70px;
            /* Shorter, stouter for a hive */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 10;
        }

        .hive-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(2px 4px 3px rgba(0, 0, 0, 0.2));
            transform-origin: top center;
            animation: swing 4s infinite ease-in-out;
        }

        @keyframes swing {

            0%,
            100% {
                transform: rotate(2deg);
            }

            50% {
                transform: rotate(-2deg);
            }
        }

        /* --- Room Styles --- */
        .room {
            min-height: 400px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            border: 6px solid #d97706;
            /* Wood/Amber color */
            position: relative;
            box-shadow: 0 8px 0px rgba(180, 83, 9, 0.2);
            overflow: hidden;
        }

        /* Wooden Header Style */
        .room-header {
            background-color: #f59e0b;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            border-bottom: 4px solid #d97706;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.2);
        }

        /* The Honeycomb Grid (Ten Frame) */
        .ten-frame-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            padding: 24px 30px;
            /* More padding to center hexagons */
            justify-items: center;
            align-items: center;
            height: 340px;
            position: relative;
        }

        /* Hexagonal Cells */
        .frame-slot {
            width: 50px;
            height: 58px;
            /* Hexagon aspect ratio */
            background-color: #fef3c7;
            /* Very light amber */
            position: relative;
            /* Create Hexagon Shape */
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            border: none;
            /* clip-path hides borders, so we rely on background contrast */
            box-shadow: inset 0 0 10px rgba(217, 119, 6, 0.2);
            /* Inner shadow for depth */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Fake border for hexagon using a pseudo-element behind (optional, keeping simple for now) */
        .frame-slot::before {
            content: '';
            position: absolute;
            inset: 2px;
            background-color: rgba(251, 191, 36, 0.1);
            /* Inner cell color */
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            z-index: 1;
        }

        /* Number inside cell */
        .frame-slot::after {
            content: attr(data-index);
            position: absolute;
            color: #d97706;
            font-size: 14px;
            font-weight: bold;
            opacity: 0.5;
            z-index: 2;
        }

        .flex-tens {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            align-content: flex-start;
            /* Stack from top like hanging hives */
            justify-content: center;
            height: 100%;
            gap: 2px;
        }

        /* --- Waiting Zone (Flower Patch) --- */
        .waiting-zone {
            display: flex;
            gap: 8px;
            padding: 12px;
            background-color: #ecfccb;
            /* Lime-100 */
            border: 3px dashed #84cc16;
            /* Lime-500 */
            border-radius: 16px;
            min-height: 70px;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            position: relative;
        }

        .waiting-label {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #65a30d;
            color: white;
            font-size: 12px;
            padding: 2px 12px;
            border-radius: 99px;
            font-weight: bold;
            box-shadow: 0 2px 0 #365314;
        }

        /* --- Animations --- */
        @keyframes popIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-60px) scale(1.5);
                opacity: 0;
            }
        }

        .full-alert {
            animation: pulse-honey 1s infinite;
            background-color: #fffbeb !important;
            /* Warm alert */
        }

        @keyframes pulse-honey {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
                border-color: #f59e0b;
            }

            50% {
                border-color: #d97706;
            }

            100% {
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
                border-color: #f59e0b;
            }
        }

        .floating-text {
            position: absolute;
            color: #d97706;
            font-weight: bold;
            font-size: 1.8rem;
            pointer-events: none;
            animation: floatUp 1.5s forwards;
            z-index: 100;
            white-space: nowrap;
            text-shadow: 2px 2px 0px white;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 12px;
            border-radius: 12px;
        }

        /* --- UI Elements --- */
        .btn {
            transition: all 0.1s;
            border-bottom-width: 4px;
            font-family: 'Fredoka', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:active:not(:disabled) {
            transform: translateY(4px);
            border-bottom-width: 0px;
        }

        .btn:disabled {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
            transform: none;
            border-bottom-width: 4px;
        }

        .btn-green {
            @apply bg-lime-500 border-lime-700 text-white;
        }

        .btn-red {
            @apply bg-rose-500 border-rose-700 text-white;
        }

        .btn-purple {
            @apply bg-violet-500 border-violet-700 text-white;
        }

        .btn-yellow {
            @apply bg-amber-400 border-amber-600 text-white;
        }

        .btn-blue {
            @apply bg-sky-500 border-sky-700 text-white;
        }

        /* Top Nav "Pills" */
        .nav-pill {
            @apply px-4 py-2 rounded-full font-bold text-amber-900 bg-white/60 border-2 border-white/50 cursor-pointer text-center transition-all select-none shadow-sm;
            min-width: 80px;
        }

        .nav-pill:hover {
            @apply bg-white border-amber-300 transform scale-105;
        }

        .nav-pill.active {
            @apply bg-amber-500 text-white border-amber-600 shadow-md;
            transform: translateY(-2px);
        }

        .ai-story-box {
            background: #fff;
            border: 3px solid #fcd34d;
            border-radius: 16px;
            padding: 16px;
            margin-top: 8px;
            font-size: 1rem;
            color: #78350f;
            box-shadow: 0 4px 0 rgba(217, 119, 6, 0.2);
            display: none;
            position: relative;
            z-index: 50;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #fed7aa;
            transition: 0.3s;
            border: 2px solid white;
        }

        .step-dot.filled {
            background: #f97316;
            transform: scale(1.2);
            border-color: #fefce8;
        }

        /* Landing Page */
        .landing-overlay {
            position: fixed;
            inset: 0;
            background-color: #fefce8;
            /* Same as body bg */
            background-image: radial-gradient(#eab308 1.5px, transparent 1.5px), radial-gradient(#eab308 1.5px, #fefce8 1.5px);
            background-size: 30px 30px;
            z-index: 100;
            display: flex;
            flex-col;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.5s ease-out;
        }

        .landing-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px 20px;
            border-radius: 32px;
            border: 8px solid #f59e0b;
            box-shadow: 0 10px 0 #d97706;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .menu-btn {
            @apply w-full mb-4 py-4 rounded-2xl text-xl font-bold text-white shadow-lg border-b-4 transition-transform active:border-b-0 active:translate-y-1 relative overflow-hidden flex items-center justify-between px-6;
        }

        /* Custom scrollbar for better feel */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #fcd34d;
            border-radius: 4px;
        }
    </style>
</head>

<body class="h-screen flex flex-col items-center overflow-hidden">

    <!-- Landing Page Overlay -->
    <div id="landing-page" class="landing-overlay">
        <div class="landing-content space-y-6">
            <h1 class="text-4xl font-black text-amber-600 mb-2 drop-shadow-sm">Âø´‰πêÂÖªËúÇÂú∫ üêù</h1>
            <p class="text-amber-800 font-medium mb-6 leading-relaxed">
                Ê¨¢ËøéÊù•Âà∞Ê¢ÖÁöÑÂÖªËúÇÂú∫ÔºÅ<br>
                ËøôÈáåÊúâÂ•ΩÂ§öÂèØÁà±ÁöÑÂ∞èËúúËúÇÁ≠âÁùÄ‰Ω†Êù•Êï∞‰∏ÄÊï∞ÔºåÁÆó‰∏ÄÁÆó„ÄÇ<br>
                Âø´Êù•‰∏ÄËµ∑Áé©ÂêßÔºÅ
            </p>

            <div class="flex flex-col gap-4 w-full">
                <button onclick="enterGame('count')" class="menu-btn bg-lime-500 border-lime-700 hover:bg-lime-400">
                    <span>1: Êï∞Êï∞ (Count)</span>
                    <span class="text-3xl">üçØ</span>
                </button>
                <button onclick="enterGame('calc')"
                    class="menu-btn bg-violet-500 border-violet-700 hover:bg-violet-400">
                    <span>2: ÊºîÁ§∫ (Demo)</span>
                    <span class="text-3xl">‚ú®</span>
                </button>
                <button onclick="enterGame('quiz')" class="menu-btn bg-rose-500 border-rose-700 hover:bg-rose-400">
                    <span>3: ÊåëÊàò (Quiz)</span>
                    <span class="text-3xl">üèÜ</span>
                </button>
            </div>

            <a href="../../index.html" class="inline-block mt-4 text-amber-500 font-bold hover:underline">‚¨ÖÔ∏è ËøîÂõû‰∏ªËèúÂçï</a>
        </div>
    </div>

    <!-- Top Nav (Hidden initially, shown after entry) -->
    <div id="top-nav"
        class="w-full max-w-2xl mt-4 px-4 flex justify-center gap-4 z-50 opacity-0 transition-opacity duration-300 pointer-events-none">
        <button id="tab-count" onclick="switchTab('count')" class="nav-pill active">1: Êï∞Êï∞ (Count)</button>
        <button id="tab-calc" onclick="switchTab('calc')" class="nav-pill">2: ÊºîÁ§∫ (Demo)</button>
        <button id="tab-quiz" onclick="switchTab('quiz')" class="nav-pill">3: ÊåëÊàò (Quiz)</button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 w-full max-w-2xl flex flex-col px-4 py-2 relative">

        <!-- Title / AI Story Area -->
        <div class="min-h-[3rem] flex flex-col items-center justify-center relative mb-2">
            <h1 id="mainTitle" class="text-3xl font-bold text-amber-700 transition-all duration-300 drop-shadow-sm">
                Âø´‰πêÂÖªËúÇÂú∫</h1>
            <div id="aiStoryDisplay" class="ai-story-box w-full">
                <div id="aiStoryContent"></div>
                <button onclick="closeStory()"
                    class="absolute top-1 right-2 text-amber-400 hover:text-red-500 text-2xl font-bold leading-none">&times;</button>
            </div>
        </div>

        <!-- The Farm (Game Board) -->
        <div class="flex gap-4 h-[420px]">

            <!-- Tens Room (Hives) -->
            <div class="flex-1 flex flex-col">
                <div class="room flex flex-col flex-1" id="tensRoom">
                    <div class="room-header bg-orange-500 border-orange-700">
                        <span>ËúÇÂ∑¢ (Hives)</span>
                        <span id="tensCountDisplay" class="text-3xl font-bold drop-shadow-md">0</span>
                    </div>
                    <div class="flex-tens" id="tensContainer"></div>
                </div>
            </div>

            <!-- Ones Room (Honeycomb) -->
            <div class="flex-1 flex flex-col">
                <div class="room flex flex-col flex-1" id="onesRoom">
                    <div class="room-header bg-yellow-500 border-yellow-700">
                        <span>Â∑•ËúÇ (Bees)</span>
                        <span id="onesCountDisplay" class="text-3xl font-bold drop-shadow-md">0</span>
                    </div>

                    <!-- The Honeycomb Grid -->
                    <div class="ten-frame-grid" id="onesContainer">
                        <!-- Slots generated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Waiting Zone (Flower Patch) -->
        <div id="waitingArea" class="hidden relative w-full mt-2">
            <div class="waiting-zone" id="waitingContainer">
                <!-- Bees wait here -->
            </div>
            <div class="waiting-label">üå∏ ÈááËúúÂå∫ (Waiting)</div>
        </div>

        <!-- Total Display -->
        <div class="absolute top-[460px] left-1/2 transform -translate-x-1/2 pointer-events-none z-20">
            <div
                class="text-3xl font-bold text-amber-800 bg-yellow-100/95 px-8 py-2 rounded-full shadow-lg border-2 border-yellow-400 backdrop-blur flex items-center gap-2">
                <span>üçØ</span> <span id="totalDisplay">0</span>
            </div>
        </div>

        <!-- Controls Area -->
        <div class="mt-auto h-24 w-full relative z-30">

            <!-- Count Mode Controls -->
            <div id="controls-count"
                class="absolute inset-0 flex justify-center items-center gap-4 transition-opacity duration-300">
                <button onclick="resetGame()"
                    class="btn btn-red px-6 py-4 rounded-2xl font-bold text-lg shadow-md w-28">
                    ÈáçÊù•
                </button>
                <button id="addBtn" onclick="userAddOne()"
                    class="btn btn-green px-8 py-4 rounded-2xl font-bold text-xl shadow-md flex-1 max-w-xs flex items-center justify-center gap-2">
                    <span>üêù È£ûÊù•‰∏ÄÂè™</span>
                </button>
            </div>

            <!-- Demo/Quiz Calculation Controls -->
            <div id="controls-calc"
                class="absolute inset-0 flex flex-col items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">

                <!-- Setup Phase -->
                <div id="calc-setup"
                    class="flex items-center gap-3 bg-white/80 backdrop-blur p-3 rounded-2xl shadow-xl border-2 border-amber-200">
                    <div class="flex flex-col items-center">
                        <label class="text-[10px] text-amber-700 font-bold uppercase">Áé∞Êúâ</label>
                        <input type="number" id="inputStart" value="7" min="0" max="99"
                            class="w-16 text-center text-2xl font-bold text-amber-800 border-2 border-amber-200 rounded-xl p-1 outline-none focus:border-orange-500 bg-white">
                    </div>
                    <span class="text-2xl text-amber-400 font-black">‚ûï</span>
                    <div class="flex flex-col items-center">
                        <label class="text-[10px] text-amber-700 font-bold uppercase">È£ûÊù•</label>
                        <input type="number" id="inputChange" value="4" min="1" max="9"
                            class="w-16 text-center text-2xl font-bold text-amber-800 border-2 border-amber-200 rounded-xl p-1 outline-none focus:border-orange-500 bg-white">
                    </div>

                    <button onclick="generateStory()"
                        class="btn w-14 h-14 rounded-2xl flex items-center justify-center ml-2 shadow-lg bg-gradient-to-br from-violet-400 to-fuchsia-500 text-white text-2xl border-b-4 border-violet-700 active:border-b-0"
                        title="È≠îÊ≥ïÊïÖ‰∫ã">‚ú®</button>

                    <button onclick="startCalculationMode()"
                        class="btn btn-blue bg-sky-500 border-sky-700 text-white px-6 py-2 rounded-2xl font-bold shadow-lg ml-2 h-14 text-lg">
                        ÂºÄÂßã
                    </button>
                </div>

                <!-- Action Phase -->
                <div id="calc-action" class="hidden w-full flex flex-col items-center gap-2">
                    <div id="step-dots" class="flex gap-2 mb-1"></div>
                    <div class="flex gap-4 w-full justify-center">
                        <button onclick="exitCalcMode()"
                            class="btn btn-red px-6 py-3 rounded-2xl font-bold shadow w-28">ÈÄÄÂá∫</button>
                        <button id="stepBtn" onclick="manualStep()"
                            class="btn btn-purple px-6 py-3 rounded-2xl font-bold text-xl shadow flex-1 max-w-sm relative overflow-hidden flex items-center justify-center">
                            <span class="relative z-10 drop-shadow" id="stepBtnText">È£ûËøõ 1 Âè™</span>
                            <div id="stepBtnProgress"
                                class="absolute left-0 top-0 bottom-0 bg-violet-700 transition-all duration-300 w-0 z-0 opacity-30">
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quiz Start Button -->
            <div id="controls-quiz"
                class="absolute inset-0 flex items-center justify-center opacity-0 pointer-events-none">
                <button onclick="nextQuestion()"
                    class="btn btn-yellow px-10 py-5 rounded-2xl font-bold text-2xl shadow-xl flex items-center gap-3 animate-bounce text-amber-900 border-amber-600">
                    üé≤ ÈöèÊú∫Âá∫È¢ò
                </button>
            </div>

        </div>

    </div>

    <script>
        // --- Configuration ---
        const apiKey = ""; // System provides this

        // --- SVGs ---

        // Standard Bee (Yellow/Black stripes)
        const svgBeeStandard = `
        <svg viewBox="0 0 100 100" class="bee-svg">
            <g>
                <!-- Wings -->
                <ellipse cx="70" cy="35" rx="20" ry="12" fill="#e0f2fe" stroke="#93c5fd" stroke-width="2" transform="rotate(-30 70 35)" opacity="0.8"/>
                <ellipse cx="30" cy="35" rx="20" ry="12" fill="#e0f2fe" stroke="#93c5fd" stroke-width="2" transform="rotate(30 30 35)" opacity="0.8"/>
                <!-- Body -->
                <ellipse cx="50" cy="55" rx="22" ry="28" fill="#facc15" stroke="#854d0e" stroke-width="2"/>
                <!-- Stripes -->
                <path d="M30 50 Q50 55 70 50" stroke="#451a03" stroke-width="4" fill="none"/>
                <path d="M30 60 Q50 65 70 60" stroke="#451a03" stroke-width="4" fill="none"/>
                <path d="M35 70 Q50 75 65 70" stroke="#451a03" stroke-width="4" fill="none"/>
                <!-- Eyes -->
                <circle cx="42" cy="40" r="3" fill="#000"/>
                <circle cx="58" cy="40" r="3" fill="#000"/>
                <!-- Smile -->
                <path d="M45 45 Q50 48 55 45" stroke="#000" stroke-width="2" fill="none"/>
            </g>
        </svg>`;

        // Added Bee (With a red flower hat/decoration to distinguish)
        const svgBeeAdded = `
        <svg viewBox="0 0 100 100" class="bee-svg">
            <g>
                <!-- Wings -->
                <ellipse cx="70" cy="35" rx="20" ry="12" fill="#e0f2fe" stroke="#93c5fd" stroke-width="2" transform="rotate(-30 70 35)" opacity="0.8"/>
                <ellipse cx="30" cy="35" rx="20" ry="12" fill="#e0f2fe" stroke="#93c5fd" stroke-width="2" transform="rotate(30 30 35)" opacity="0.8"/>
                <!-- Body (Slightly more orange) -->
                <ellipse cx="50" cy="55" rx="22" ry="28" fill="#fbbf24" stroke="#854d0e" stroke-width="2"/>
                <!-- Stripes -->
                <path d="M30 50 Q50 55 70 50" stroke="#451a03" stroke-width="4" fill="none"/>
                <path d="M30 60 Q50 65 70 60" stroke="#451a03" stroke-width="4" fill="none"/>
                <path d="M35 70 Q50 75 65 70" stroke="#451a03" stroke-width="4" fill="none"/>
                <!-- Eyes -->
                <circle cx="42" cy="40" r="3" fill="#000"/>
                <circle cx="58" cy="40" r="3" fill="#000"/>
                <!-- Flower Hat -->
                <circle cx="50" cy="28" r="8" fill="#f43f5e" />
                <circle cx="50" cy="28" r="3" fill="#fef08a" />
            </g>
        </svg>`;

        // Hive SVG
        const svgHive = `
        <svg viewBox="0 0 100 100" class="hive-svg">
            <g transform="translate(10, 10) scale(0.8)">
                <!-- Branch -->
                <path d="M50 0 L50 20" stroke="#5D4037" stroke-width="6" stroke-linecap="round"/>
                <!-- Hive Layers -->
                <path d="M30 20 Q50 15 70 20 L75 30 Q50 35 25 30 Z" fill="#FBC02D" stroke="#E65100" stroke-width="2"/>
                <path d="M25 30 Q50 25 75 30 L80 45 Q50 50 20 45 Z" fill="#FDD835" stroke="#E65100" stroke-width="2"/>
                <path d="M20 45 Q50 40 80 45 L85 60 Q50 65 15 60 Z" fill="#FBC02D" stroke="#E65100" stroke-width="2"/>
                <path d="M15 60 Q50 55 85 60 L80 75 Q50 80 20 75 Z" fill="#FDD835" stroke="#E65100" stroke-width="2"/>
                <path d="M20 75 Q50 70 80 75 L70 90 Q50 95 30 90 Z" fill="#FBC02D" stroke="#E65100" stroke-width="2"/>
                <!-- Door -->
                <circle cx="50" cy="60" r="8" fill="#3E2723"/>
            </g>
        </svg>`;

        // --- State ---
        let ones = 0;
        let tens = 0;
        let isAnimating = false;
        let currentMode = 'count';
        let calcTarget = 0;
        let calcProgress = 0;
        let waitingButterflies = 0;

        // --- DOM ---
        const els = {
            onesContainer: document.getElementById('onesContainer'),
            tensContainer: document.getElementById('tensContainer'),
            onesRoom: document.getElementById('onesRoom'),
            tensRoom: document.getElementById('tensRoom'),
            tensCountDisplay: document.getElementById('tensCountDisplay'),
            onesCountDisplay: document.getElementById('onesCountDisplay'),
            totalDisplay: document.getElementById('totalDisplay'),
            waitingArea: document.getElementById('waitingArea'),
            waitingContainer: document.getElementById('waitingContainer'),
            mainTitle: document.getElementById('mainTitle'),
            stepBtn: document.getElementById('stepBtn'),
            stepBtnText: document.getElementById('stepBtnText'),
            stepBtnProgress: document.getElementById('stepBtnProgress'),
            inputStart: document.getElementById('inputStart'),
            inputChange: document.getElementById('inputChange'),
            aiStoryDisplay: document.getElementById('aiStoryDisplay'),
            aiStoryContent: document.getElementById('aiStoryContent')
        };

        // --- Core Logic ---
        function initTenFrame() {
            els.onesContainer.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const slot = document.createElement('div');
                slot.className = 'frame-slot';
                slot.dataset.index = i + 1;
                slot.id = `slot-${i}`;
                els.onesContainer.appendChild(slot);
            }
        }
        initTenFrame();

        function updateDisplay() {
            els.tensCountDisplay.innerText = tens;
            els.onesCountDisplay.innerText = ones;
            els.totalDisplay.innerText = (tens * 10) + ones;
        }

        function renderBeeInCell(index, type = 'standard') {
            const slot = document.getElementById(`slot-${index}`);
            if (!slot) return;
            slot.innerHTML = '';

            const div = document.createElement('div');
            div.className = 'block-one w-full h-full';
            div.innerHTML = type === 'added' ? svgBeeAdded : svgBeeStandard;

            slot.appendChild(div);
        }

        function addWaitingBee() {
            const div = document.createElement('div');
            div.className = 'block-one';
            div.innerHTML = svgBeeAdded; // Waiting bees are always the "added" type
            els.waitingContainer.appendChild(div);
        }

        async function addOne(type = 'standard', animateFromWaiting = false) {
            if (ones >= 10) return;
            const targetIndex = ones;

            if (animateFromWaiting) {
                const waiter = els.waitingContainer.firstElementChild;
                if (waiter) waiter.remove();
            }

            renderBeeInCell(targetIndex, type);
            ones++;
            updateDisplay();

            if (ones === 10) {
                await performRegrouping();
            }
        }

        async function performRegrouping() {
            isAnimating = true;
            updateGlobalButtons();

            els.onesRoom.classList.add('full-alert');
            showFloatingText("Êª°ÂëòÂï¶! (Hive Full!)", els.onesRoom);
            await sleep(1000);

            if (!isAnimating) { els.onesRoom.classList.remove('full-alert'); return; }

            initTenFrame(); // Clear ones
            ones = 0;
            updateDisplay();
            els.onesRoom.classList.remove('full-alert');

            // Add Hive
            tens++;
            const hive = document.createElement('div');
            hive.className = 'block-ten';
            hive.innerHTML = svgHive;
            els.tensContainer.appendChild(hive);

            showFloatingText("ÂèòËúÇÂ∑¢! (+1 Hive)", els.tensRoom, '#d97706');
            // --- Landing Page Logic ---
            function enterGame(mode) {
                // Hide Landing
                const landing = document.getElementById('landing-page');
                landing.style.opacity = '0';
                setTimeout(() => {
                    landing.style.display = 'none';

                    // Show Nav
                    const nav = document.getElementById('top-nav');
                    nav.classList.remove('opacity-0', 'pointer-events-none');

                    // Start Game
                    switchTab(mode);
                }, 500);
            }

            // --- Tab Switching ---
            function switchTab(mode) {
                currentMode = mode;
                // Update Active Tab State
                document.querySelectorAll('.nav-pill').forEach(b => b.classList.remove('active'));
                document.getElementById(`tab-${mode}`).classList.add('active');

                // Hide/Show Controls
                document.getElementById('controls-count').style.opacity = (mode === 'count') ? '1' : '0';
                document.getElementById('controls-count').style.pointerEvents = (mode === 'count') ? 'auto' : 'none';

                document.getElementById('controls-calc').style.opacity = (mode === 'calc') ? '1' : '0';
                // Calc pointer events handled by its own logic (setup vs action)
                document.getElementById('controls-calc').style.pointerEvents = (mode === 'calc') ? 'auto' : 'none';

                document.getElementById('controls-quiz').style.opacity = (mode === 'quiz') ? '1' : '0';
                document.getElementById('controls-quiz').style.pointerEvents = (mode === 'quiz') ? 'auto' : 'none';

                if (mode === 'count') {
                    resetGame();
                    els.inputStart.value = 7;
                    els.inputChange.value = 4;
                } else if (mode === 'calc') {
                    resetGame();
                    exitCalcMode(); // Show setup
                } else if (mode === 'quiz') {
                    resetGame();
                    // We'll enter quiz mode properly when they click Start button in quiz UI, 
                    // but actually the current UI has a big button "Random Question".
                    // Let's just make sure reset works.
                }
                closeStory();
            }

            function exitCalcMode() {
                document.getElementById('calc-setup').classList.remove('hidden');
                document.getElementById('calc-action').classList.add('hidden');
                els.waitingArea.classList.add('hidden');
                resetGame();
                if (currentMode === 'quiz') {
                    // If exiting quiz via this logic (which reuses calc UI components), go back to blank.
                    // Actually quiz mode shares calc UI logic? 
                    // Looking at code above... 'controls-quiz' only has one button: "Random Question"
                    // When clicked, nextQuestion() runs.
                }
            }

            // --- Speech Logic ---
            function speakText(text) {
                if (!text) return;
                // Cancel any current speech
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = "zh-CN";
                utterance.rate = 1.0;
                utterance.pitch = 1.2;

                // Try to select a Chinese voice if available
                const voices = window.speechSynthesis.getVoices();
                console.log("Voices:", voices); // Debug

                // Heuristic for Chinese voice
                const zhVoice = voices.find(v => v.lang.includes('zh') || v.lang.includes('CN'));
                if (zhVoice) {
                    utterance.voice = zhVoice;
                }

                window.speechSynthesis.speak(utterance);
            }

            // Make sure voices are loaded (Chrome sometimes needs this)
            window.speechSynthesis.onvoiceschanged = () => {
                console.log("Voices changed");
            };

            // --- Generative AI Logic ---
            /*
               We want to generate a SHORT, fun 1-sentence story about bees.
               E.g. "7Âè™Â∞èËúúËúÇÊ≠£Âú®ÈááËúúÔºåÁ™ÅÁÑ∂È£ûÊù•‰∫Ü4Âè™ÊúãÂèãÔºÅ"
            */
            async function generateStory() {
                const startVal = els.inputStart.value;
                const changeVal = els.inputChange.value;
                const prompt = `Use simple Chinese for a 6-year-old. Write ONE short sentence: ${startVal} bees are in the hive, and ${changeVal} more fly in. Use emojis.`;

                // Simple loading state
                els.aiStoryDisplay.style.display = 'block';
                els.aiStoryContent.innerHTML = '‚ú® Ê≠£Âú®ÊÉ≥ÊïÖ‰∫ã... (Thinking...)';

                try {
                    // Construct the Gemini API call
                    // Note: For a real deployed app, you'd want a backend proxy to hide the key.
                    // Since this is a local/personal script, we put key here.
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }]
                        })
                    });

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "ËúúËúÇ‰ª¨ÈÉΩÂæàÂºÄÂøÉÔºÅ(Bees are happy!)";

                    // Clean up markdown just in case
                    const cleanText = marked.parse(text);

                    els.aiStoryContent.innerHTML = cleanText;
                    speakText(text); // Speak the story!

                } catch (e) {
                    console.error(e);
                    els.aiStoryContent.innerText = "ÁΩëÁªúÊúâÁÇπÂøôÔºåËúúËúÇ‰ª¨ÂÖàÂéªÈááËúúÂï¶ÔºÅ";
                }
            }

            function closeStory() {
                els.aiStoryDisplay.style.display = 'none';
                window.speechSynthesis.cancel();
            }


            // --- Quiz Logic ---
            function nextQuestion() {
                // Randomize
                const s = Math.floor(Math.random() * 8) + 1; // 1-8
                const c = Math.floor(Math.random() * 8) + 1; // 1-8

                els.inputStart.value = s;
                els.inputChange.value = c;

                // Re-use Calc UI but set mode
                // We need to hide the 'quiz' controls (the big button) and show the 'calc' UI 
                // BUT keeps us logically in 'quiz' mode so we know what to do when finished

                // Actually, my structure has separate 'controls-calc' and 'controls-quiz' divs.
                // Let's just swap them visually for the duration of the question.
                document.getElementById('controls-quiz').style.opacity = '0';
                document.getElementById('controls-quiz').style.pointerEvents = 'none';

                document.getElementById('controls-calc').style.opacity = '1';
                document.getElementById('controls-calc').style.pointerEvents = 'auto'; // allow input

                // Generate a story automatically? Sure, why not
                generateStory();

                // Auto start?
                // startCalculationMode(); 
            }

    </script> function showFloatingText(text, container, color = '#d97706') {
    const el = document.createElement('div');
    el.className = 'floating-text';
    el.style.color = color;
    el.innerText = text;
    el.style.top = '50%';
    el.style.left = '50%';
    el.style.transform = 'translate(-50%, -50%)';
    container.appendChild(el);
    setTimeout(() => el.remove(), 1500);
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function updateGlobalButtons() {
    const disabled = isAnimating;
    document.querySelectorAll('button').forEach(b => {
    if (!b.classList.contains('tab-btn') && !b.classList.contains('absolute')) {
    b.disabled = disabled;
    }
    });
    }

    function switchTab(mode) {
    currentMode = mode;
    ['count', 'calc', 'quiz'].forEach(m => {
    document.getElementById(`tab-${m}`).classList.toggle('active', m === mode);
    });

    document.getElementById('controls-count').style.opacity = '0';
    document.getElementById('controls-count').style.pointerEvents = 'none';
    document.getElementById('controls-calc').style.opacity = '0';
    document.getElementById('controls-calc').style.pointerEvents = 'none';
    document.getElementById('controls-quiz').style.opacity = '0';
    document.getElementById('controls-quiz').style.pointerEvents = 'none';

    resetGame();

    if (mode === 'count') {
    document.getElementById('controls-count').style.opacity = '1';
    document.getElementById('controls-count').style.pointerEvents = 'auto';
    els.mainTitle.innerText = "Âø´‰πêÂÖªËúÇÂú∫";
    els.waitingArea.classList.add('hidden');
    } else if (mode === 'calc') {
    document.getElementById('controls-calc').style.opacity = '1';
    document.getElementById('controls-calc').style.pointerEvents = 'auto';
    document.getElementById('calc-setup').classList.remove('hidden');
    document.getElementById('calc-action').classList.add('hidden');
    els.mainTitle.innerText = "Ëøõ‰ΩçÊºîÁ§∫";
    } else {
    document.getElementById('controls-quiz').style.opacity = '1';
    document.getElementById('controls-quiz').style.pointerEvents = 'auto';
    els.mainTitle.innerText = "ÊåëÊàòÊó∂Èó¥";
    }
    }

    async function generateStory() {
    const start = els.inputStart.value;
    const change = els.inputChange.value;
    const prompt = `‰∏∫6Â≤ÅÂ≠©Â≠êÂÜô‰∏™‰∏ÄÂè•ËØùÊïÖ‰∫ã: ${start}Âè™Â∞èËúúËúÇÂú®ÈááËúúÔºåÂèàÈ£ûÊù•‰∫Ü${change}Âè™„ÄÇÂ¶ÇÊûúÁõ∏Âä†Ë∂ÖËøá10ÔºåÊèêÂà∞"Ë£ÖÊª°‰∫Ü‰∏Ä‰∏™Â§ßËúÇÂ∑¢"„ÄÇÁî®‰∏≠Êñá„ÄÇ`;

    els.aiStoryDisplay.style.display = 'block';
    els.aiStoryContent.innerHTML = "Ê≠£Âú®Âê¨ËúúËúÇËØ¥ËØù...";

    try {
    if (!apiKey) throw new Error("No Key");
    const res = await
    fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
    {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    const data = await res.json();
    els.aiStoryContent.innerText = data.candidates[0].content.parts[0].text;
    } catch (e) {
    const sum = parseInt(start) + parseInt(change);
    let text = `Ëä±Âõ≠ÈáåÊúâ ${start} Âè™Â∞èËúúËúÇÔºåÂèàÈ£ûÊù•‰∫Ü ${change} Âè™„ÄÇ`;
    if (start % 10 + parseInt(change) >= 10) text += " ËúÇÂ∑¢Â•ΩÂÉèË¶ÅË£Ö‰∏ç‰∏ã‰∫ÜÔºÅ";
    els.aiStoryContent.innerText = text;
    }
    }
    function closeStory() { els.aiStoryDisplay.style.display = 'none'; }

    </script>
</body>

</html>