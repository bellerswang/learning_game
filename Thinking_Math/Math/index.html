<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MayÁöÑÂø´‰πêÂÖªËúÇÂú∫ (May's Bee Farm)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+SC:wght@400;700&display=swap');

        body {
            font-family: 'Fredoka', 'Noto Sans SC', sans-serif;
            background-color: #fefce8;
            /* Yellow-50 */
            /* Honeycomb background pattern */
            background-image: radial-gradient(#eab308 1.5px, transparent 1.5px), radial-gradient(#eab308 1.5px, #fefce8 1.5px);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            touch-action: manipulation;
            user-select: none;
        }

        /* --- Bee Styles --- */
        .block-one {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            z-index: 20;
        }

        .bee-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(1px 3px 2px rgba(0, 0, 0, 0.15));
            animation: buzz 2s infinite ease-in-out;
        }

        @keyframes buzz {

            0%,
            100% {
                transform: translateY(0) rotate(0);
            }

            25% {
                transform: translateY(-3px) rotate(-5deg);
            }

            75% {
                transform: translateY(3px) rotate(5deg);
            }
        }

        /* --- Beehive (Ten Block) --- */
        .block-ten {
            width: 60px;
            height: 70px;
            /* Shorter, stouter for a hive */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 10;
        }

        .hive-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(2px 4px 3px rgba(0, 0, 0, 0.2));
            transform-origin: top center;
            animation: swing 4s infinite ease-in-out;
        }

        @keyframes swing {

            0%,
            100% {
                transform: rotate(2deg);
            }

            50% {
                transform: rotate(-2deg);
            }
        }

        /* --- Room Styles --- */
        .room {
            min-height: 400px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            border: 6px solid #d97706;
            /* Wood/Amber color */
            position: relative;
            box-shadow: 0 8px 0px rgba(180, 83, 9, 0.2);
            overflow: hidden;
        }

        /* Wooden Header Style */
        .room-header {
            background-color: #f59e0b;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            border-bottom: 4px solid #d97706;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.2);
        }

        /* The Honeycomb Grid (Ten Frame) - High Contrast */
        .ten-frame-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            padding: 24px 30px;
            justify-items: center;
            align-items: center;
            height: 340px;
            position: relative;
            background-color: #FFFFFF;
            border: 4px solid #000000;
            border-radius: 12px;
            margin: 8px;
        }

        /* Frame Cells - High Contrast Square Design */
        .frame-slot {
            width: 50px;
            height: 50px;
            background-color: #FFFFFF;
            position: relative;
            border: 3px solid #000000;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Number inside cell - High Contrast */
        .frame-slot::after {
            content: attr(data-index);
            position: absolute;
            color: #000000;
            font-size: 12px;
            font-weight: bold;
            opacity: 0.3;
            z-index: 2;
        }

        /* Hives Container - High Contrast */
        .flex-tens {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            align-content: flex-start;
            justify-content: center;
            height: 100%;
            gap: 8px;
            background-color: #FFFFFF;
            border: 4px solid #000000;
            border-radius: 12px;
            margin: 8px;
        }

        /* --- Waiting Zone (Flower Patch) --- */
        .waiting-zone {
            display: flex;
            gap: 8px;
            padding: 12px;
            background-color: #ecfccb;
            /* Lime-100 */
            border: 3px dashed #84cc16;
            /* Lime-500 */
            border-radius: 16px;
            min-height: 70px;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            position: relative;
        }

        .waiting-label {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #65a30d;
            color: white;
            font-size: 12px;
            padding: 2px 12px;
            border-radius: 99px;
            font-weight: bold;
            box-shadow: 0 2px 0 #365314;
        }

        /* --- Animations --- */
        @keyframes popIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-60px) scale(1.5);
                opacity: 0;
            }
        }

        .full-alert {
            animation: pulse-honey 1s infinite;
            background-color: #fffbeb !important;
            /* Warm alert */
        }

        @keyframes pulse-honey {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
                border-color: #f59e0b;
            }

            50% {
                border-color: #d97706;
            }

            100% {
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
                border-color: #f59e0b;
            }
        }

        .floating-text {
            position: absolute;
            color: #d97706;
            font-weight: bold;
            font-size: 1.8rem;
            pointer-events: none;
            animation: floatUp 1.5s forwards;
            z-index: 100;
            white-space: nowrap;
            text-shadow: 2px 2px 0px white;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 12px;
            border-radius: 12px;
        }

        /* --- UI Elements --- */
        .btn {
            transition: all 0.1s;
            border-bottom-width: 4px;
            font-family: 'Fredoka', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:active:not(:disabled) {
            transform: translateY(4px);
            border-bottom-width: 0px;
        }

        .btn:disabled {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
            transform: none;
            border-bottom-width: 4px;
        }

        .btn-green {
            @apply bg-lime-500 border-lime-700 text-white;
        }

        .btn-red {
            @apply bg-rose-500 border-rose-700 text-white;
        }

        .btn-purple {
            @apply bg-violet-500 border-violet-700 text-white;
        }

        .btn-yellow {
            @apply bg-amber-400 border-amber-600 text-white;
        }

        .btn-blue {
            @apply bg-sky-500 border-sky-700 text-white;
        }

        /* Top Nav "Pills" */
        .nav-pill {
            @apply px-4 py-2 rounded-full font-bold text-amber-900 bg-white/60 border-2 border-white/50 cursor-pointer text-center select-none shadow-sm;
            min-width: 80px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-pill::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-pill:hover::before {
            opacity: 1;
        }

        .nav-pill:hover {
            @apply bg-white border-amber-300;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-pill:active {
            transform: translateY(0) scale(0.98);
        }

        .nav-pill.active {
            @apply bg-amber-500 text-white border-amber-600;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4), 0 3px 6px rgba(0, 0, 0, 0.15);
            animation: gentle-pulse 2s ease-in-out infinite;
        }

        @keyframes gentle-pulse {

            0%,
            100% {
                box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4), 0 3px 6px rgba(0, 0, 0, 0.15);
            }

            50% {
                box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6), 0 3px 8px rgba(0, 0, 0, 0.2);
            }
        }


        .ai-story-box {
            background: #fff;
            border: 3px solid #fcd34d;
            border-radius: 16px;
            padding: 16px;
            margin-top: 8px;
            font-size: 1rem;
            color: #78350f;
            box-shadow: 0 4px 0 rgba(217, 119, 6, 0.2);
            display: none;
            position: relative;
            z-index: 50;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #fed7aa;
            transition: 0.3s;
            border: 2px solid white;
        }

        .step-dot.filled {
            background: #f97316;
            transform: scale(1.2);
            border-color: #fefce8;
        }

        /* Landing Page */
        .landing-overlay {
            position: fixed;
            inset: 0;
            background-color: #fefce8;
            /* Same as body bg */
            background-image: radial-gradient(#eab308 1.5px, transparent 1.5px), radial-gradient(#eab308 1.5px, #fefce8 1.5px);
            background-size: 30px 30px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.5s ease-out;
        }

        .landing-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px 20px;
            border-radius: 32px;
            border: 8px solid #f59e0b;
            box-shadow: 0 10px 0 #d97706;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .menu-btn {
            @apply w-full mb-4 py-4 rounded-2xl text-xl font-bold text-white shadow-lg border-b-4 transition-transform active:border-b-0 active:translate-y-1 relative overflow-hidden flex items-center justify-between px-6;
        }

        /* Custom scrollbar for better feel */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #fcd34d;
            border-radius: 4px;
        }

        /* === CPA ENHANCEMENTS === */

        /* Ghost Bee in Empty Slots */
        .frame-slot .ghost-bee {
            opacity: 0.15;
            filter: grayscale(100%);
            pointer-events: none;
        }

        /* Gap Highlight Animation */
        .frame-slot.highlight-gap {
            animation: pulseGap 0.8s ease-in-out infinite;
        }

        @keyframes pulseGap {

            0%,
            100% {
                box-shadow: inset 0 0 15px rgba(239, 68, 68, 0.3);
                background-color: #fef3c7;
            }

            50% {
                box-shadow: inset 0 0 25px rgba(239, 68, 68, 0.6);
                background-color: #fee2e2;
            }
        }

        /* Waiting Zone Visual Grouping */
        .waiting-zone {
            flex-wrap: wrap;
        }

        .waiting-group {
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 12px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .waiting-group.fill-group {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
        }

        .waiting-group.remainder-group {
            background: rgba(168, 162, 158, 0.15);
            border: 2px dashed #a8a29e;
            opacity: 0.7;
        }

        .group-label {
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 6px;
            margin-right: 4px;
        }

        .fill-group .group-label {
            background: #22c55e;
            color: white;
        }

        .remainder-group .group-label {
            background: #a8a29e;
            color: white;
        }

        .group-divider {
            width: 3px;
            height: 40px;
            background: linear-gradient(to bottom, transparent, #d97706, transparent);
            margin: 0 8px;
        }

        /* Formula Highlight Sync */
        .formula-num {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .formula-num.active {
            background: #fbbf24;
            color: #78350f;
            transform: scale(1.2);
            font-weight: bold;
        }

        .formula-num.completed {
            background: #22c55e;
            color: white;
        }

        /* Step Message Overlay */
        .step-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 24px;
            border-radius: 16px;
            border: 3px solid #f59e0b;
            font-size: 1.2rem;
            font-weight: bold;
            color: #78350f;
            z-index: 100;
            animation: bounceIn 0.4s ease;
            text-align: center;
        }

        @keyframes bounceIn {
            0% {
                transform: translate(-50%, -50%) scale(0);
            }

            60% {
                transform: translate(-50%, -50%) scale(1.1);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* Celebrate Regroup Animation */
        @keyframes celebrateRegroup {
            0% {
                transform: scale(1);
            }

            25% {
                transform: scale(1.1) rotate(-5deg);
            }

            50% {
                transform: scale(1.2) rotate(5deg);
            }

            75% {
                transform: scale(1.1) rotate(-3deg);
            }

            100% {
                transform: scale(1) rotate(0);
            }
        }

        .celebrating {
            animation: celebrateRegroup 0.6s ease;
        }

        /* === MILESTONE 4: Gather to Center Animation === */
        @keyframes gatherToCenter {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            70% {
                transform: translate(var(--dx), var(--dy)) scale(0.3);
                opacity: 0.8;
            }

            100% {
                transform: translate(var(--dx), var(--dy)) scale(0);
                opacity: 0;
            }
        }

        .gathering-bee {
            animation: gatherToCenter 0.8s ease-in forwards;
        }

        /* Hive appear animation */
        @keyframes hiveAppear {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }

            60% {
                transform: scale(1.3) rotate(10deg);
            }

            100% {
                transform: scale(1) rotate(0);
                opacity: 1;
            }
        }

        .hive-appear {
            animation: hiveAppear 0.6s ease-out forwards;
        }

        /* Missing Count Badge */
        .missing-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            z-index: 30;
        }

        /* === TEN FRIENDS GAME MODE === */

        .friend-option {
            min-width: 100px;
            padding: 16px 24px;
            border-radius: 20px;
            border: 4px solid;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: white;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .friend-option:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.2);
        }

        .friend-option:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
        }

        .friend-option:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .friend-option.correct {
            background: #22c55e;
            color: white;
            border-color: #15803d;
            animation: popCorrect 0.5s ease;
        }

        .friend-option.wrong {
            animation: shake 0.5s ease;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-10px);
            }

            40% {
                transform: translateX(10px);
            }

            60% {
                transform: translateX(-10px);
            }

            80% {
                transform: translateX(10px);
            }
        }

        @keyframes popCorrect {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        /* === SHAPE BLOCKS (Bee Clusters) for Ten Friends === */
        .bee-shape-block {
            display: grid;
            gap: 2px;
            padding: 8px;
            background: white;
            border: 4px solid #000;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .bee-shape-block:hover:not(:disabled) {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.3);
        }

        .bee-shape-block:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.3);
        }

        .bee-shape-block:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .bee-shape-block.correct {
            background: #22c55e;
            border-color: #15803d;
            animation: popCorrect 0.5s ease;
        }

        .bee-shape-block.wrong {
            animation: shake 0.5s ease;
            border-color: #ef4444;
        }

        /* Shape layouts */
        .shape-row-1 {
            grid-template-columns: repeat(1, 28px);
        }

        .shape-row-2 {
            grid-template-columns: repeat(2, 28px);
        }

        .shape-row-3 {
            grid-template-columns: repeat(3, 28px);
        }

        .shape-row-4 {
            grid-template-columns: repeat(4, 28px);
        }

        .shape-row-5 {
            grid-template-columns: repeat(5, 28px);
        }

        .mini-bee {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24 60%, #f59e0b 100%);
            border: 2px solid #000;
            position: relative;
        }

        .mini-bee::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #000;
            border-radius: 50%;
        }

        /* Fly-in animation */
        @keyframes flyToSlot {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                transform: scale(0.5) translateY(-50px);
            }

            100% {
                opacity: 0;
                transform: scale(0) translateY(-100px);
            }
        }

        .flying-bee {
            animation: flyToSlot 0.4s ease-out forwards;
        }

        /* Option colors with high contrast */
        .bee-shape-block.opt-cyan {
            border-color: #0891b2;
            background: #ecfeff;
        }

        .bee-shape-block.opt-pink {
            border-color: #db2777;
            background: #fdf2f8;
        }

        .bee-shape-block.opt-orange {
            border-color: #ea580c;
            background: #fff7ed;
        }
    </style>
</head>

<body class="h-screen flex flex-col items-center overflow-hidden">

    <!-- Landing Page Overlay -->
    <div id="landing-page" class="landing-overlay">
        <div class="landing-content space-y-6">
            <h1 class="text-4xl font-black text-amber-600 mb-2 drop-shadow-sm">Âø´‰πêÂÖªËúÇÂú∫ üêù</h1>
            <p class="text-amber-800 font-medium mb-6 leading-relaxed">
                Ê¨¢ËøéÊù•Âà∞Ê¢ÖÁöÑÂÖªËúÇÂú∫ÔºÅ<br>
                ËøôÈáåÊúâÂ•ΩÂ§öÂèØÁà±ÁöÑÂ∞èËúúËúÇÁ≠âÁùÄ‰Ω†Êù•Êï∞‰∏ÄÊï∞ÔºåÁÆó‰∏ÄÁÆó„ÄÇ<br>
                Âø´Êù•‰∏ÄËµ∑Áé©ÂêßÔºÅ
            </p>

            <div class="flex flex-col gap-4 w-full">
                <button onclick="enterGame('count')" class="menu-btn bg-lime-500 border-lime-700 hover:bg-lime-400">
                    <span>1: Êï∞Êï∞ (Count)</span>
                    <span class="text-3xl">üçØ</span>
                </button>
                <button onclick="enterGame('calc')"
                    class="menu-btn bg-violet-500 border-violet-700 hover:bg-violet-400">
                    <span>2: ÊºîÁ§∫ (Demo)</span>
                    <span class="text-3xl">‚ú®</span>
                </button>
                <button onclick="enterGame('quiz')" class="menu-btn bg-rose-500 border-rose-700 hover:bg-rose-400">
                    <span>3: ÊåëÊàò (Quiz)</span>
                    <span class="text-3xl">üèÜ</span>
                </button>
                <button onclick="enterGame('friends')" class="menu-btn bg-cyan-500 border-cyan-700 hover:bg-cyan-400">
                    <span>4: ÊâæÊúãÂèã (Ten Friends)</span>
                    <span class="text-3xl">ü§ù</span>
                </button>
            </div>

            <a href="../../index.html" class="inline-block mt-4 text-amber-500 font-bold hover:underline">‚¨ÖÔ∏è ËøîÂõû‰∏ªËèúÂçï</a>
        </div>
    </div>

    <div id="top-nav"
        class="w-full max-w-2xl mt-4 px-4 flex justify-center gap-2 flex-wrap z-50 opacity-0 transition-opacity duration-300 pointer-events-none">
        <button id="tab-count" onclick="switchTab('count')" class="nav-pill active">1: Êï∞Êï∞</button>
        <button id="tab-calc" onclick="switchTab('calc')" class="nav-pill">2: ÊºîÁ§∫</button>
        <button id="tab-quiz" onclick="switchTab('quiz')" class="nav-pill">3: ÊåëÊàò</button>
        <button id="tab-friends" onclick="switchTab('friends')" class="nav-pill">4: ÊâæÊúãÂèã</button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 w-full max-w-2xl flex flex-col px-4 py-2 relative">

        <!-- Title & Calculation Display Area -->
        <div class="min-h-[3rem] flex flex-col items-center justify-center relative mb-2">
            <h1 id="mainTitle" class="text-3xl font-bold text-amber-700 transition-all duration-300 drop-shadow-sm">
                Âø´‰πêÂÖªËúÇÂú∫</h1>

            <!-- Math Decomposition (Demo Mode Only) -->
            <div id="math-breakdown"
                class="hidden mt-2 px-4 py-2 bg-gradient-to-r from-violet-100 to-purple-100 border-2 border-violet-400 rounded-xl shadow-md">
                <div id="breakdown-formula" class="text-xl font-bold text-purple-800 text-center">
                    <!-- e.g., "7 + 4 = 7 + 3 + 1" -->
                </div>
            </div>
        </div>

        <!-- The Farm (Game Board) -->
        <div class="flex gap-4 h-[420px]">

            <!-- Tens Room (Hives) -->
            <div class="flex-1 flex flex-col">
                <div class="room flex flex-col flex-1" id="tensRoom">
                    <div class="room-header bg-orange-500 border-orange-700">
                        <span>ËúÇÂ∑¢ (Hives)</span>
                        <span id="tensCountDisplay" class="text-3xl font-bold drop-shadow-md">0</span>
                    </div>
                    <div class="flex-tens" id="tensContainer"></div>
                </div>
            </div>

            <!-- Ones Room (Honeycomb) -->
            <div class="flex-1 flex flex-col">
                <div class="room flex flex-col flex-1" id="onesRoom">
                    <div class="room-header bg-yellow-500 border-yellow-700">
                        <span>Â∑•ËúÇ (Bees)</span>
                        <span id="onesCountDisplay" class="text-3xl font-bold drop-shadow-md">0</span>
                    </div>

                    <!-- The Honeycomb Grid -->
                    <div class="ten-frame-grid" id="onesContainer">
                        <!-- Slots generated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Waiting Zone (Flower Patch) -->
        <div id="waitingArea" class="hidden relative w-full mt-2">
            <div class="waiting-zone" id="waitingContainer">
                <!-- Bees wait here -->
            </div>
            <div class="waiting-label">üå∏ ÈááËúúÂå∫ (Waiting)</div>
        </div>

        <!-- Total Display -->
        <div class="absolute top-[460px] left-1/2 transform -translate-x-1/2 pointer-events-none z-20">
            <div
                class="text-3xl font-bold text-amber-800 bg-yellow-100/95 px-8 py-2 rounded-full shadow-lg border-2 border-yellow-400 backdrop-blur flex items-center gap-2">
                <span>üçØ</span> <span id="totalDisplay">0</span>
            </div>
        </div>

        <!-- === MILESTONE 5: Number Bond Panel === -->
        <div id="number-bond-panel"
            class="hidden w-full mt-4 p-4 bg-white border-4 border-violet-400 rounded-2xl shadow-lg">
            <div class="flex items-center justify-center gap-4">
                <!-- Main equation display -->
                <div class="text-2xl font-bold text-violet-800">
                    <span id="bond-start">7</span> + <span id="bond-change">5</span> =
                </div>

                <!-- Tree diagram -->
                <div class="flex flex-col items-center">
                    <div class="text-lg font-bold text-violet-600 mb-1">ÊãÜÂàÜ</div>
                    <div class="flex items-end gap-4">
                        <!-- Left branch (fill amount) -->
                        <div class="flex flex-col items-center">
                            <input type="number" id="bond-fill-input"
                                class="w-14 h-14 text-center text-2xl font-bold border-4 border-green-400 rounded-xl bg-green-50 focus:border-green-600 outline-none"
                                min="0" max="10" placeholder="?">
                            <span class="text-xs text-green-600 font-bold mt-1">üéÅ Âáë10</span>
                        </div>

                        <div class="text-2xl text-violet-400 font-bold pb-6">+</div>

                        <!-- Right branch (remainder) -->
                        <div class="flex flex-col items-center">
                            <input type="number" id="bond-remainder-input"
                                class="w-14 h-14 text-center text-2xl font-bold border-4 border-orange-400 rounded-xl bg-orange-50 focus:border-orange-600 outline-none"
                                min="0" max="10" placeholder="?">
                            <span class="text-xs text-orange-600 font-bold mt-1">üêù ‰Ωô‰∏ã</span>
                        </div>
                    </div>
                </div>

                <!-- Verify button -->
                <button id="bond-verify-btn" onclick="verifyNumberBond()"
                    class="btn btn-green px-6 py-3 rounded-xl font-bold shadow-md">
                    ‚úì È™åËØÅ
                </button>
            </div>
            <div id="bond-feedback" class="hidden mt-2 text-center text-lg font-bold"></div>
        </div>

        <!-- Controls Area -->
        <div class="mt-auto h-24 w-full relative z-30">

            <!-- Count Mode Controls -->
            <div id="controls-count"
                class="absolute inset-0 flex justify-center items-center gap-4 transition-opacity duration-300">
                <button onclick="resetGame()"
                    class="btn btn-red px-6 py-4 rounded-2xl font-bold text-lg shadow-md w-28">
                    ÈáçÊù•
                </button>
                <button id="addBtn" onclick="userAddOne()"
                    class="btn btn-green px-8 py-4 rounded-2xl font-bold text-xl shadow-md flex-1 max-w-xs flex items-center justify-center gap-2">
                    <span>üêù È£ûÊù•‰∏ÄÂè™</span>
                </button>
            </div>

            <!-- Demo/Quiz Calculation Controls -->
            <div id="controls-calc"
                class="absolute inset-0 flex flex-col items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">

                <!-- Setup Phase -->
                <div id="calc-setup"
                    class="flex items-center gap-3 bg-white/80 backdrop-blur p-3 rounded-2xl shadow-xl border-2 border-amber-200">
                    <div class="flex flex-col items-center">
                        <label class="text-[10px] text-amber-700 font-bold uppercase">Áé∞Êúâ</label>
                        <input type="number" id="inputStart" value="7" min="0" max="99"
                            class="w-16 text-center text-2xl font-bold text-amber-800 border-2 border-amber-200 rounded-xl p-1 outline-none focus:border-orange-500 bg-white">
                    </div>

                    <!-- Operator Toggle -->
                    <button id="demoOperatorBtn" onclick="toggleDemoOperator()"
                        class="text-3xl font-black w-12 h-12 rounded-xl bg-amber-100 border-2 border-amber-300 hover:bg-amber-200 transition-all">
                        <span id="demoOperatorIcon">‚ûï</span>
                    </button>

                    <div class="flex flex-col items-center">
                        <label id="changeLabel" class="text-[10px] text-amber-700 font-bold uppercase">È£ûÊù•</label>
                        <input type="number" id="inputChange" value="4" min="1" max="9"
                            class="w-16 text-center text-2xl font-bold text-amber-800 border-2 border-amber-200 rounded-xl p-1 outline-none focus:border-orange-500 bg-white">
                    </div>

                    <button onclick="startCalculationMode()"
                        class="btn btn-blue bg-sky-500 border-sky-700 text-white px-6 py-2 rounded-2xl font-bold shadow-lg ml-2 h-14 text-lg">
                        ÂºÄÂßã
                    </button>
                </div>

                <!-- Action Phase -->
                <div id="calc-action" class="hidden w-full flex flex-col items-center gap-2">
                    <div id="step-dots" class="flex gap-2 mb-1"></div>
                    <div class="flex gap-4 w-full justify-center">
                        <button onclick="exitCalcMode()"
                            class="btn btn-red px-6 py-3 rounded-2xl font-bold shadow w-28">ÈÄÄÂá∫</button>
                        <button id="stepBtn" onclick="manualStep()"
                            class="btn btn-purple px-6 py-3 rounded-2xl font-bold text-xl shadow flex-1 max-w-sm relative overflow-hidden flex items-center justify-center">
                            <span class="relative z-10 drop-shadow" id="stepBtnText">È£ûËøõ 1 Âè™</span>
                            <div id="stepBtnProgress"
                                class="absolute left-0 top-0 bottom-0 bg-violet-700 transition-all duration-300 w-0 z-0 opacity-30">
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quiz Start Button -->
            <div id="controls-quiz"
                class="absolute inset-0 flex items-center justify-center opacity-0 pointer-events-none">
                <button onclick="nextQuestion()"
                    class="btn btn-yellow px-10 py-5 rounded-2xl font-bold text-2xl shadow-xl flex items-center gap-3 animate-bounce text-amber-900 border-amber-600">
                    üé≤ ÈöèÊú∫Âá∫È¢ò
                </button>
            </div>

            <!-- Ten Friends Mode Controls -->
            <div id="controls-friends"
                class="absolute inset-0 flex flex-col items-center justify-center gap-4 opacity-0 pointer-events-none transition-opacity duration-300">
                <div id="friends-question" class="text-xl font-bold text-amber-700 mb-2">
                    ËøòÂ∑ÆÂá†Âè™ÂáëÊàê10Ôºü
                </div>
                <div id="friends-options" class="flex gap-4 justify-center flex-wrap">
                    <!-- Options generated by JS -->
                </div>
                <div id="friends-score" class="text-lg font-bold text-amber-600 mt-2">
                    ÂæóÂàÜ: <span id="friendsScoreDisplay">0</span>
                </div>
            </div>

        </div>

    </div>

    <!-- Blind Quiz Interface (Hidden by default) -->
    <div id="quiz-interface"
        class="hidden fixed inset-0 z-30 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center pt-20">
        <div class="mb-8 p-6 bg-white border-4 border-amber-400 rounded-3xl shadow-xl transform scale-110">
            <div id="quiz-question" class="text-6xl font-black text-amber-600 tracking-wider">
                <!-- 7 + 5 = ? -->
            </div>
            <div id="quiz-input-display"
                class="mt-4 h-16 bg-amber-50 rounded-xl border-2 border-amber-200 flex items-center justify-center text-4xl font-bold text-amber-800">
                ?
            </div>
        </div>

        <!-- Numpad -->
        <div class="grid grid-cols-3 gap-3 p-4 bg-amber-100 rounded-2xl border-2 border-amber-300 shadow-inner">
            <button onclick="quizInput(1)" class="numpad-btn">1</button>
            <button onclick="quizInput(2)" class="numpad-btn">2</button>
            <button onclick="quizInput(3)" class="numpad-btn">3</button>
            <button onclick="quizInput(4)" class="numpad-btn">4</button>
            <button onclick="quizInput(5)" class="numpad-btn">5</button>
            <button onclick="quizInput(6)" class="numpad-btn">6</button>
            <button onclick="quizInput(7)" class="numpad-btn">7</button>
            <button onclick="quizInput(8)" class="numpad-btn">8</button>
            <button onclick="quizInput(9)" class="numpad-btn">9</button>
            <button onclick="quizInput('back')"
                class="numpad-btn bg-red-100 text-red-600 border-red-200 hover:bg-red-200">‚å´</button>
            <button onclick="quizInput(0)" class="numpad-btn">0</button>
            <button onclick="submitQuiz()"
                class="numpad-btn bg-green-100 text-green-600 border-green-200 hover:bg-green-200">OK</button>
        </div>
    </div>

    <!-- Result View (Hidden by default) -->
    <div id="result-interface"
        class="hidden fixed inset-0 z-30 bg-amber-50 flex flex-col items-center justify-center pt-20">
        <h2 class="text-4xl font-black text-amber-600 mb-6 drop-shadow-sm">‚úÖ ÂõûÁ≠îÊ≠£Á°Æ!</h2>

        <div class="flex flex-col items-center gap-2 mb-8">
            <div
                class="text-2xl font-bold text-amber-800 bg-white px-6 py-2 rounded-full shadow-sm border border-amber-200">
                Á≠îÊ°àÊòØ
            </div>
            <div id="result-number" class="text-8xl font-black text-amber-600 drop-shadow-md">
                12
            </div>
        </div>

        <!-- Visual Representation -->
        <div id="result-visuals"
            class="flex flex-wrap justify-center gap-4 p-4 w-full max-w-lg mb-8 min-h-[140px] items-center">
            <!-- Hives and Bees injected here -->
        </div>

        <button onclick="nextQuestion()"
            class="btn btn-yellow px-10 py-4 rounded-2xl font-bold text-2xl shadow-xl flex items-center gap-3 animate-bounce">
            ‰∏ã‰∏ÄÈ¢ò ‚û°Ô∏è
        </button>
    </div>

    <style>
        .numpad-btn {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background: white;
            border: 2px solid #fbbf24;
            color: #d97706;
            font-size: 2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            box-shadow: 0 4px 0 rgba(245, 158, 11, 0.2);
        }

        .numpad-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .shake-horizontal {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }
    </style>

    <script>
        // --- Error Handling for Debugging ---
        window.onerror = function (msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            return false;
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const apiKey = ""; // System provides this

            // --- SVGs ---
            // (Keep SVGs here or move them out if they are constants. They are constants, so global is fine, but let's keep scope clean)
            // Ideally we define constants globally.

            initGame();
        });

        // --- SVGs (Global Constants) ---
        const svgBeeStandard = `
        <svg viewBox="0 0 100 100" class="bee-svg">
            <g>
                <ellipse cx="70" cy="35" rx="20" ry="12" fill="#e0f2fe" stroke="#1e3a5f" stroke-width="2" transform="rotate(-30 70 35)" opacity="0.9"/>
                <ellipse cx="30" cy="35" rx="20" ry="12" fill="#e0f2fe" stroke="#1e3a5f" stroke-width="2" transform="rotate(30 30 35)" opacity="0.9"/>
                <ellipse cx="50" cy="55" rx="22" ry="28" fill="#facc15" stroke="#000000" stroke-width="3"/>
                <path d="M30 50 Q50 55 70 50" stroke="#000000" stroke-width="5" fill="none"/>
                <path d="M30 60 Q50 65 70 60" stroke="#000000" stroke-width="5" fill="none"/>
                <path d="M35 70 Q50 75 65 70" stroke="#000000" stroke-width="5" fill="none"/>
                <circle cx="42" cy="40" r="4" fill="#000"/>
                <circle cx="58" cy="40" r="4" fill="#000"/>
                <path d="M45 45 Q50 48 55 45" stroke="#000" stroke-width="2" fill="none"/>
            </g>
        </svg>`;

        const svgBeeAdded = `
        <svg viewBox="0 0 100 100" class="bee-svg">
            <g>
                <ellipse cx="70" cy="35" rx="20" ry="12" fill="#e0f2fe" stroke="#1e3a5f" stroke-width="2" transform="rotate(-30 70 35)" opacity="0.9"/>
                <ellipse cx="30" cy="35" rx="20" ry="12" fill="#e0f2fe" stroke="#1e3a5f" stroke-width="2" transform="rotate(30 30 35)" opacity="0.9"/>
                <ellipse cx="50" cy="55" rx="22" ry="28" fill="#fbbf24" stroke="#000000" stroke-width="3"/>
                <path d="M30 50 Q50 55 70 50" stroke="#000000" stroke-width="5" fill="none"/>
                <path d="M30 60 Q50 65 70 60" stroke="#000000" stroke-width="5" fill="none"/>
                <path d="M35 70 Q50 75 65 70" stroke="#000000" stroke-width="5" fill="none"/>
                <circle cx="42" cy="40" r="4" fill="#000"/>
                <circle cx="58" cy="40" r="4" fill="#000"/>
                <circle cx="50" cy="28" r="8" fill="#f43f5e" stroke="#000" stroke-width="2"/>
                <circle cx="50" cy="28" r="3" fill="#fef08a"/>
            </g>
        </svg>`;

        const svgHive = `
        <svg viewBox="0 0 100 100" class="hive-svg">
            <g transform="translate(10, 10) scale(0.8)">
                <path d="M50 0 L50 20" stroke="#5D4037" stroke-width="6" stroke-linecap="round"/>
                <path d="M30 20 Q50 15 70 20 L75 30 Q50 35 25 30 Z" fill="#FBC02D" stroke="#E65100" stroke-width="2"/>
                <path d="M25 30 Q50 25 75 30 L80 45 Q50 50 20 45 Z" fill="#FDD835" stroke="#E65100" stroke-width="2"/>
                <path d="M20 45 Q50 40 80 45 L85 60 Q50 65 15 60 Z" fill="#FBC02D" stroke="#E65100" stroke-width="2"/>
                <path d="M15 60 Q50 55 85 60 L80 75 Q50 80 20 75 Z" fill="#FDD835" stroke="#E65100" stroke-width="2"/>
                <path d="M20 75 Q50 70 80 75 L70 90 Q50 95 30 90 Z" fill="#FBC02D" stroke="#E65100" stroke-width="2"/>
                <circle cx="50" cy="60" r="8" fill="#3E2723"/>
            </g>
        </svg>`;

        // --- State ---
        let ones = 0;
        let tens = 0;
        let isAnimating = false;
        let currentMode = 'count';
        let calcTarget = 0;
        let calcProgress = 0;
        let els = {}; // Initialize empty
        let calcLog = []; // Track calculation steps
        let initialValue = 0; // Track starting value for log

        // CPA Animation State
        let cpaStep = 0; // Legacy - kept for compatibility
        let needToFill = 0; // How many bees needed to make 10
        let remainderCount = 0; // Bees left after filling

        // === MILESTONE 4: State Machine ===
        // States: IDLE -> HIGHLIGHT_GAP -> MOVE_FILL -> REGROUP_ANIMATION -> MOVE_REMAINDER -> FINISHED
        let stepState = 'IDLE';
        let decomposition = null; // Store current decomposition result

        // === MILESTONE 2: Pure Decomposition Logic ===
        function calculateDecomposition(currentOnes, adding) {
            const spaceAvailable = 10 - currentOnes;
            if (adding <= spaceAvailable) {
                // No regrouping needed
                return { fill: adding, remainder: 0, regroup: false };
            } else {
                // Will cross 10 - need to regroup
                return {
                    fill: spaceAvailable,
                    remainder: adding - spaceAvailable,
                    regroup: true
                };
            }
        }

        // Ten Friends Game State
        let friendsScore = 0;
        let friendsAnswer = 0; // Correct answer for current puzzle

        // Ghost Bee SVG (faded version for empty slots)
        const svgBeeGhost = `
        <svg viewBox="0 0 100 100" class="bee-svg ghost-bee">
            <g>
                <ellipse cx="70" cy="35" rx="20" ry="12" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2" transform="rotate(-30 70 35)" opacity="0.4"/>
                <ellipse cx="30" cy="35" rx="20" ry="12" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2" transform="rotate(30 30 35)" opacity="0.4"/>
                <ellipse cx="50" cy="55" rx="22" ry="28" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2" opacity="0.3"/>
                <path d="M30 50 Q50 55 70 50" stroke="#9ca3af" stroke-width="3" fill="none" opacity="0.3"/>
                <path d="M30 60 Q50 65 70 60" stroke="#9ca3af" stroke-width="3" fill="none" opacity="0.3"/>
                <path d="M35 70 Q50 75 65 70" stroke="#9ca3af" stroke-width="3" fill="none" opacity="0.3"/>
            </g>
        </svg>`;

        function initGame() {
            els = {
                onesContainer: document.getElementById('onesContainer'),
                tensContainer: document.getElementById('tensContainer'),
                onesRoom: document.getElementById('onesRoom'),
                tensRoom: document.getElementById('tensRoom'),
                tensCountDisplay: document.getElementById('tensCountDisplay'),
                onesCountDisplay: document.getElementById('onesCountDisplay'),
                totalDisplay: document.getElementById('totalDisplay'),
                waitingArea: document.getElementById('waitingArea'),
                waitingContainer: document.getElementById('waitingContainer'),
                mainTitle: document.getElementById('mainTitle'),
                stepBtn: document.getElementById('stepBtn'),
                stepBtnText: document.getElementById('stepBtnText'),
                stepBtnProgress: document.getElementById('stepBtnProgress'),
                inputStart: document.getElementById('inputStart'),
                inputChange: document.getElementById('inputChange'),
                mathBreakdown: document.getElementById('math-breakdown'),
                breakdownFormula: document.getElementById('breakdown-formula')
            };

            initTenFrame();
        }

        function initTenFrame() {
            els.onesContainer.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const slot = document.createElement('div');
                slot.className = 'frame-slot';
                slot.dataset.index = i + 1;
                slot.id = `slot-${i}`;
                // Add ghost bee for visual "missing" indicator
                const ghostDiv = document.createElement('div');
                ghostDiv.className = 'block-one w-full h-full';
                ghostDiv.innerHTML = svgBeeGhost;
                slot.appendChild(ghostDiv);
                els.onesContainer.appendChild(slot);
            }
        }

        // === CPA HELPER FUNCTIONS ===

        function highlightEmptySlots() {
            for (let i = ones; i < 10; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (slot) slot.classList.add('highlight-gap');
            }
        }

        function clearHighlights() {
            document.querySelectorAll('.frame-slot').forEach(slot => {
                slot.classList.remove('highlight-gap');
            });
        }

        function showStepMessage(text, container, duration = 1500) {
            // Remove any existing message
            container.querySelectorAll('.step-message').forEach(m => m.remove());

            const msg = document.createElement('div');
            msg.className = 'step-message';
            msg.innerHTML = text;
            container.appendChild(msg);

            if (duration > 0) {
                setTimeout(() => msg.remove(), duration);
            }
            return msg;
        }

        function groupWaitingBees(fillCount, remainder) {
            els.waitingContainer.innerHTML = '';

            if (fillCount > 0) {
                // Fill group (gift for the hive - will fill the ten frame)
                const fillGroup = document.createElement('div');
                fillGroup.className = 'waiting-group fill-group';
                const fillLabel = document.createElement('span');
                fillLabel.className = 'group-label';
                fillLabel.textContent = 'üéÅ ÁªôËúÇÂ∑¢ÁöÑÁ§ºÁâ©';
                fillGroup.appendChild(fillLabel);

                for (let i = 0; i < fillCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'block-one';
                    div.innerHTML = svgBeeAdded;
                    fillGroup.appendChild(div);
                }
                els.waitingContainer.appendChild(fillGroup);
            }

            if (fillCount > 0 && remainder > 0) {
                // Physical divider with clear separation
                const divider = document.createElement('div');
                divider.className = 'group-divider';
                divider.innerHTML = '<span style="font-size:20px">‚û°Ô∏è</span>';
                els.waitingContainer.appendChild(divider);
            }

            if (remainder > 0) {
                // Remainder group (friends waiting - will move after regrouping)
                const remGroup = document.createElement('div');
                remGroup.className = 'waiting-group remainder-group';
                const remLabel = document.createElement('span');
                remLabel.className = 'group-label';
                remLabel.textContent = 'üêù Ââ©‰∏ãÁöÑÂ∞è‰ºô‰º¥';
                remGroup.appendChild(remLabel);

                for (let i = 0; i < remainder; i++) {
                    const div = document.createElement('div');
                    div.className = 'block-one';
                    div.innerHTML = svgBeeAdded;
                    remGroup.appendChild(div);
                }
                els.waitingContainer.appendChild(remGroup);
            }
        }

        function updateFormulaHighlight(step) {
            const nums = els.breakdownFormula.querySelectorAll('.formula-num');
            nums.forEach(n => n.classList.remove('active', 'completed'));

            if (step === 'fill') {
                nums.forEach(n => {
                    if (n.dataset.step === 'fill') n.classList.add('active');
                });
            } else if (step === 'remainder') {
                nums.forEach(n => {
                    if (n.dataset.step === 'fill') n.classList.add('completed');
                    if (n.dataset.step === 'remainder') n.classList.add('active');
                });
            } else if (step === 'done') {
                nums.forEach(n => n.classList.add('completed'));
            }
        }

        function updateDisplay() {
            els.tensCountDisplay.innerText = tens;
            els.onesCountDisplay.innerText = ones;
            els.totalDisplay.innerText = (tens * 10) + ones;
        }

        function renderBeeInCell(index, type = 'standard') {
            const slot = document.getElementById(`slot-${index}`);
            if (!slot) return;
            slot.innerHTML = '';

            const div = document.createElement('div');
            div.className = 'block-one w-full h-full';
            div.innerHTML = type === 'added' ? svgBeeAdded : svgBeeStandard;

            slot.appendChild(div);
        }

        function addWaitingBee() {
            const div = document.createElement('div');
            div.className = 'block-one';
            div.innerHTML = svgBeeAdded; // Waiting bees are always the "added" type
            els.waitingContainer.appendChild(div);
        }

        async function addOne(type = 'standard', animateFromWaiting = false) {
            if (ones >= 10) return;
            const targetIndex = ones;

            if (animateFromWaiting) {
                const waiter = els.waitingContainer.firstElementChild;
                if (waiter) waiter.remove();
            }

            renderBeeInCell(targetIndex, type);
            ones++;
            updateDisplay();

            if (ones === 10) {
                await performRegrouping();
            }
        }

        async function performRegrouping() {
            isAnimating = true;
            updateGlobalButtons();

            els.onesRoom.classList.add('full-alert');
            showFloatingText("Êª°ÂëòÂï¶! (Hive Full!)", els.onesRoom);
            await sleep(800);

            if (!isAnimating) { els.onesRoom.classList.remove('full-alert'); return; }

            // === MILESTONE 4: Gather Animation ===
            // Get all bees in the frame and animate them gathering to center
            const frameSlots = els.onesContainer.querySelectorAll('.frame-slot');
            const centerX = els.onesContainer.offsetWidth / 2;
            const centerY = els.onesContainer.offsetHeight / 2;

            // Apply gather animation to each bee
            frameSlots.forEach((slot, i) => {
                const bee = slot.querySelector('.block-one');
                if (bee) {
                    const rect = slot.getBoundingClientRect();
                    const containerRect = els.onesContainer.getBoundingClientRect();
                    const slotCenterX = rect.left - containerRect.left + rect.width / 2;
                    const slotCenterY = rect.top - containerRect.top + rect.height / 2;

                    const dx = centerX - slotCenterX;
                    const dy = centerY - slotCenterY;

                    bee.style.setProperty('--dx', `${dx}px`);
                    bee.style.setProperty('--dy', `${dy}px`);
                    bee.classList.add('gathering-bee');
                }
            });

            await sleep(800); // Wait for gather animation

            // Clear the ten frame
            initTenFrame();
            ones = 0;
            updateDisplay();
            els.onesRoom.classList.remove('full-alert');

            // Add Hive with appear animation
            tens++;
            const hive = document.createElement('div');
            hive.className = 'block-ten hive-appear';
            hive.innerHTML = svgHive;
            els.tensContainer.appendChild(hive);

            showFloatingText("ÂèòËúÇÂ∑¢! (+1 Hive)", els.tensRoom, '#d97706');
            updateDisplay();

            await sleep(600);
            hive.classList.remove('hive-appear');
            isAnimating = false;
            updateGlobalButtons();
        }

        // === SUBTRACTION FUNCTIONS ===
        async function removeOne() {
            if (ones <= 0) return;

            isAnimating = true;
            updateGlobalButtons();

            // Find the last bee and animate it flying away
            const lastBeeIndex = ones - 1;
            const slot = document.getElementById(`slot-${lastBeeIndex}`);
            const bee = slot?.querySelector('.block-one');

            if (bee) {
                bee.classList.add('gathering-bee');
                bee.style.setProperty('--dx', '100px');
                bee.style.setProperty('--dy', '-50px');
                await sleep(400);
                bee.remove();
            }

            ones--;
            updateDisplay();

            // Show ghost bee in empty slot
            if (slot) {
                slot.innerHTML = svgBeeGhost;
            }

            isAnimating = false;
            updateGlobalButtons();
        }

        async function performUnbundling() {
            isAnimating = true;
            updateGlobalButtons();

            // Remove the last hive
            const lastHive = els.tensContainer.lastElementChild;
            if (lastHive) {
                lastHive.classList.add('gathering-bee');
                lastHive.style.setProperty('--dx', '100px');
                lastHive.style.setProperty('--dy', '0px');
                await sleep(400);
                lastHive.remove();
            }
            tens--;
            updateDisplay();

            // Fill the ten frame with 10 bees
            initTenFrame();
            for (let i = 0; i < 10; i++) {
                renderBeeInCell(i, 'standard');
            }
            ones = 10;
            updateDisplay();

            showFloatingText("ÊãÜÊàê10Âè™! (Unbundle)", els.onesRoom, '#16a34a');
            await sleep(400);

            isAnimating = false;
            updateGlobalButtons();
        }

        function resetGame() {
            isAnimating = false;
            document.body.style.cursor = 'default';
            updateGlobalButtons();

            ones = 0;
            tens = 0;
            cpaStep = 0;
            needToFill = 0;
            remainderCount = 0;
            els.tensContainer.innerHTML = '';
            els.waitingContainer.innerHTML = '';
            initTenFrame();
            updateDisplay();
            els.onesRoom.classList.remove('full-alert');
            clearHighlights();
        }

        async function userAddOne() {
            if (isAnimating) return;

            // Highlight empty slots
            highlightEmptySlots();

            await addOne('standard');

            // Show popup with remaining count
            const remaining = 10 - ones;
            if (remaining > 0) {
                showStepMessage(`ËøòÂ∑Æ <b>${remaining}</b> Âè™Âà∞10! üêù`, els.onesRoom, 1200);
            } else {
                // Will be handled by regrouping animation
            }
            setTimeout(() => clearHighlights(), 800);
        }

        // Old quiz functions removed (moved to later)

        async function playAutoCalculation() {
            // Auto-step through the calculation
            isAnimating = true; // Block manual clicks

            // Show breakdown for educational value now that they solved it
            showDecomposition(parseInt(els.inputStart.value), parseInt(els.inputChange.value), needToFill, remainderCount);

            // Loop through all steps
            for (let i = 0; i < calcTarget; i++) {
                await manualStep();
                await sleep(300); // Speed up a bit for auto-play
            }

            // Done
            showFloatingText("üéâ ÂõûÁ≠îÊ≠£Á°Æ! üéâ", document.body, '#16a34a');
            await sleep(1000);
            nextQuestion();
        }

        function showDecomposition(start, change, fillCount, remainder) {
            const onesDigit = start % 10;

            let formula = '';
            if (remainder > 0 && onesDigit > 0) {
                // Crossing 10: e.g., 7 + 4 = 7 + 3 + 1
                formula = `<span class="formula-num" data-step="start">${start}</span> + ` +
                    `<span class="formula-num" data-step="change">${change}</span> = ` +
                    `<span class="formula-num" data-step="start">${start}</span> + ` +
                    `<span class="formula-num" data-step="fill">${fillCount}</span> + ` +
                    `<span class="formula-num" data-step="remainder">${remainder}</span>`;
            } else {
                // Simple addition
                formula = `<span class="formula-num" data-step="start">${start}</span> + ` +
                    `<span class="formula-num" data-step="change">${change}</span> = ` +
                    `<span class="formula-num" data-step="result">${start + change}</span>`;
            }

            els.breakdownFormula.innerHTML = formula;
            els.mathBreakdown.classList.remove('hidden');
        }

        // Subtraction decomposition display
        // e.g., 13 - 5 = 13 - 3 - 2 (first remove 3 to get to 10, then remove 2 more)
        function showSubtractionDecomposition(start, change, firstRemove, afterBorrow) {
            let formula = '';
            if (afterBorrow > 0) {
                // Crossing 10: e.g., 13 - 5 = 13 - 3 - 2
                formula = `<span class="formula-num" data-step="start">${start}</span> - ` +
                    `<span class="formula-num" data-step="change">${change}</span> = ` +
                    `<span class="formula-num" data-step="start">${start}</span> - ` +
                    `<span class="formula-num" data-step="fill">${firstRemove}</span> - ` +
                    `<span class="formula-num" data-step="remainder">${afterBorrow}</span>`;
            } else {
                // Simple subtraction
                formula = `<span class="formula-num" data-step="start">${start}</span> - ` +
                    `<span class="formula-num" data-step="change">${change}</span> = ` +
                    `<span class="formula-num" data-step="result">${start - change}</span>`;
            }

            els.breakdownFormula.innerHTML = formula;
            els.mathBreakdown.classList.remove('hidden');
        }

        async function manualStep() {
            if (isAnimating) return;

            // If done, exit or next question
            if (calcProgress >= calcTarget) {
                updateFormulaHighlight('done');
                if (currentMode === 'quiz') nextQuestion();
                else exitCalcMode();
                return;
            }

            isAnimating = true;
            updateGlobalButtons();

            if (demoOperator === '+') {
                // === ADDITION LOGIC ===
                const isFillingPhase = cpaStep === 0 && remainderCount > 0;

                // Show educational message on first bee of fill phase
                if (currentMode !== 'quiz' && isFillingPhase && calcProgress === 0 && needToFill > 0) {
                    const missing = 10 - ones;
                    highlightEmptySlots();
                    showStepMessage(`ËøòÂ∑Æ <b>${missing}</b> Âè™ÂáëÊª°10! üîç`, els.onesRoom, 1500);
                    updateFormulaHighlight('fill');
                    await sleep(800);
                    clearHighlights();
                }

                // Add ONE bee
                const animateWaiting = (currentMode === 'calc');
                await addOne('added', animateWaiting);
                calcProgress++;

                // Remove one bee from the waiting group
                if (currentMode === 'calc') {
                    const fillGroup = els.waitingContainer.querySelector('.fill-group');
                    if (fillGroup && fillGroup.querySelector('.block-one')) {
                        const beeInFill = fillGroup.querySelector('.block-one');
                        beeInFill.remove();
                        if (!fillGroup.querySelector('.block-one')) {
                            fillGroup.remove();
                            const divider = els.waitingContainer.querySelector('.group-divider');
                            if (divider) divider.remove();
                        }
                    } else {
                        const remGroup = els.waitingContainer.querySelector('.remainder-group');
                        if (remGroup && remGroup.querySelector('.block-one')) {
                            const beeInRem = remGroup.querySelector('.block-one');
                            beeInRem.remove();
                            if (!remGroup.querySelector('.block-one')) {
                                remGroup.remove();
                            }
                        }
                    }
                }

                // Check if frame is full - regroup
                if (ones === 10) {
                    showStepMessage(`Êª°10Âè™Âï¶! ‚ú®<br>ÂèòÊàê1‰∏™ËúÇÂ∑¢!`, els.onesRoom, 2000);
                    els.onesRoom.classList.add('celebrating');
                    await sleep(1000);
                    els.onesRoom.classList.remove('celebrating');
                    await performRegrouping();
                    if (remainderCount > 0) {
                        updateFormulaHighlight('remainder');
                    }
                }

            } else {
                // === SUBTRACTION LOGIC ===
                // Show message on first removal
                if (calcProgress === 0 && needToFill > 0) {
                    showStepMessage(`ÂÖàÁßªËµ∞ <b>${needToFill}</b> Âè™! üëã`, els.onesRoom, 1500);
                    updateFormulaHighlight('fill');
                    await sleep(800);
                }

                // Remove ONE bee
                await removeOne();
                calcProgress++;

                // Check if we hit 0 bees and need to borrow
                if (ones === 0 && remainderCount > 0 && tens > 0) {
                    showStepMessage(`ËúÇÂ∑¢ÊãÜÂºÄ! üîì`, els.tensRoom, 1500);
                    els.tensRoom.classList.add('celebrating');
                    await sleep(800);
                    els.tensRoom.classList.remove('celebrating');

                    // Borrow: convert one hive to 10 bees
                    await performUnbundling();
                    updateFormulaHighlight('remainder');
                }
            }

            updateStepUI();
            isAnimating = false;
            updateGlobalButtons();
        }

        function updateStepUI() {
            const dotsContainer = document.getElementById('step-dots');
            dotsContainer.innerHTML = '';
            const limit = Math.min(calcTarget, 10);
            for (let i = 0; i < limit; i++) {
                const dot = document.createElement('div');
                dot.className = `step-dot ${i < calcProgress ? 'filled' : ''}`;
                dotsContainer.appendChild(dot);
            }

            const remaining = calcTarget - calcProgress;
            const pct = calcTarget > 0 ? (calcProgress / calcTarget) * 100 : 0;
            els.stepBtnProgress.style.width = `${pct}%`;

            if (remaining === 0) {
                els.stepBtnText.innerText = "ÂÆåÊàê! (Done)";
                els.stepBtn.classList.remove('btn-purple');
                els.stepBtn.classList.add('btn-green');
            } else {
                // Different text for addition vs subtraction
                const actionText = demoOperator === '+' ? 'È£ûËøõ' : 'È£ûËµ∞';
                els.stepBtnText.innerText = `${actionText} 1 Âè™ (Ââ© ${remaining})`;
                els.stepBtn.classList.add('btn-purple');
                els.stepBtn.classList.remove('btn-green');
            }
        }

        // --- Landing Page Logic ---
        function enterGame(mode) {
            // Hide Landing
            const landing = document.getElementById('landing-page');
            landing.style.opacity = '0';
            setTimeout(() => {
                landing.style.display = 'none';

                // Show Nav
                const nav = document.getElementById('top-nav');
                nav.classList.remove('opacity-0', 'pointer-events-none');

                // Start Game
                switchTab(mode);
            }, 500);
        }

        // --- Tab Switching ---
        function switchTab(mode) {
            currentMode = mode;
            // Update Active Tab State
            document.querySelectorAll('.nav-pill').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');

            // ALWAYS hide quiz overlays when switching tabs
            document.getElementById('quiz-interface').classList.add('hidden');
            document.getElementById('result-interface').classList.add('hidden');
            document.getElementById('number-bond-panel').classList.add('hidden');

            // Reset room visibility
            document.getElementById('tensRoom').style.visibility = 'visible';
            document.getElementById('onesRoom').style.visibility = 'visible';

            // Hide/Show Controls
            document.getElementById('controls-count').style.opacity = (mode === 'count') ? '1' : '0';
            document.getElementById('controls-count').style.pointerEvents = (mode === 'count') ? 'auto' : 'none';

            document.getElementById('controls-calc').style.opacity = (mode === 'calc') ? '1' : '0';
            document.getElementById('controls-calc').style.pointerEvents = (mode === 'calc') ? 'auto' : 'none';

            document.getElementById('controls-quiz').style.opacity = (mode === 'quiz') ? '1' : '0';
            document.getElementById('controls-quiz').style.pointerEvents = (mode === 'quiz') ? 'auto' : 'none';

            document.getElementById('controls-friends').style.opacity = (mode === 'friends') ? '1' : '0';
            document.getElementById('controls-friends').style.pointerEvents = (mode === 'friends') ? 'auto' : 'none';

            if (mode === 'count') {
                resetGame();
                els.inputStart.value = 7;
                els.inputChange.value = 4;
                // Show board
                document.getElementById('tensRoom').style.display = 'flex';
                document.getElementById('onesRoom').style.display = 'flex';
            } else if (mode === 'calc') {
                resetGame();
                exitCalcMode(); // Show setup
                // Show board
                document.getElementById('tensRoom').style.display = 'flex';
                document.getElementById('onesRoom').style.display = 'flex';
            } else if (mode === 'quiz') {
                resetGame();
                // HIDE the game board in quiz mode
                document.getElementById('tensRoom').style.display = 'none';
                document.getElementById('onesRoom').style.display = 'none';
                // Also hide any leftover interfaces
                document.getElementById('quiz-interface').classList.add('hidden');
                document.getElementById('result-interface').classList.add('hidden');
                // Automatically generate a question
                setTimeout(() => nextQuestion(), 100); // Small delay to ensure reset completes
            } else if (mode === 'friends') {
                resetGame();
                startFriendsPuzzle();
                // Show board
                document.getElementById('tensRoom').style.display = 'flex';
                document.getElementById('onesRoom').style.display = 'flex';
            }
        }

        function exitCalcMode() {
            document.getElementById('calc-setup').classList.remove('hidden');
            document.getElementById('calc-action').classList.add('hidden');
            els.waitingArea.classList.add('hidden');
            els.mathBreakdown.classList.add('hidden');
            clearHighlights();
            resetGame();
        }


        // Global for operator
        let currentOperator = '+';
        let demoOperator = '+'; // Separate operator for Demo mode

        // Toggle Demo operator (+/-)
        function toggleDemoOperator() {
            demoOperator = demoOperator === '+' ? '-' : '+';
            const icon = document.getElementById('demoOperatorIcon');
            const label = document.getElementById('changeLabel');

            if (demoOperator === '+') {
                icon.textContent = '‚ûï';
                label.textContent = 'È£ûÊù•';
            } else {
                icon.textContent = '‚ûñ';
                label.textContent = 'È£ûËµ∞';
            }
        }

        // --- Quiz Logic ---
        function nextQuestion() {
            currentOperator = Math.random() > 0.5 ? '+' : '-';

            let s, c;

            if (currentOperator === '+') {
                // Addition: Sum >= 10
                s = Math.floor(Math.random() * 9) + 1; // 1-9
                const min_c = 10 - s;
                // c can be from min_c to 9
                const range = 9 - min_c + 1;
                c = Math.floor(Math.random() * range) + min_c;
            } else {
                // Subtraction: Minuend 11-18, Result < 10 (Crossing 10)
                // s = Minuend, c = Subtrahend
                // We want s - c < 10 => c > s - 10

                s = Math.floor(Math.random() * 8) + 11; // 11 to 18
                const min_c = s - 9; // result max is 9
                // max_c is s - 1 (result min is 1)
                const max_c = s - 1;

                // Also optionally ensure c is single digit? Usually Subtrahend is single digit for these exercises
                const actual_max_c = Math.min(max_c, 9);

                const range = actual_max_c - min_c + 1;
                c = Math.floor(Math.random() * range) + min_c;
            }

            els.inputStart.value = s;
            els.inputChange.value = c;

            // HACK: Store operator in dataset or global to use in startCalculationMode
            // For simplicity, we just use the global currentOperator we defined.

            document.getElementById('controls-quiz').style.opacity = '0';
            document.getElementById('controls-quiz').style.pointerEvents = 'none';

            document.getElementById('controls-calc').style.opacity = '1';
            document.getElementById('controls-calc').style.pointerEvents = 'auto'; // allow input

            // Hide result interface if showing
            document.getElementById('result-interface').classList.add('hidden');

            // Start the calculation immediately for quiz mode
            startCalculationMode();
        }

        // Update startCalculationMode to handle operator display
        async function startCalculationMode() {
            if (isAnimating) return;

            const startVal = parseInt(els.inputStart.value) || 0;
            const changeVal = parseInt(els.inputChange.value) || 0;

            // Default logic mainly for Demo/Calc mode
            if (currentMode === 'calc') {
                currentOperator = demoOperator; // Use the demo operator toggle
                ones = 0;
                tens = 0;
                els.tensContainer.innerHTML = '';
                initTenFrame();

                const startTens = Math.floor(startVal / 10);
                for (let i = 0; i < startTens; i++) {
                    tens++;
                    const hive = document.createElement('div');
                    hive.className = 'block-ten';
                    hive.innerHTML = svgHive;
                    els.tensContainer.appendChild(hive);
                }
                const startOnes = startVal % 10;
                for (let i = 0; i < startOnes; i++) {
                    renderBeeInCell(i, 'standard');
                    ones++;
                }
                updateDisplay();

                if (demoOperator === '+') {
                    // ADDITION LOGIC
                    const emptySlots = 10 - ones;
                    if (changeVal > emptySlots && ones > 0) {
                        needToFill = emptySlots;
                        remainderCount = changeVal - emptySlots;
                    } else {
                        needToFill = changeVal;
                        remainderCount = 0;
                    }

                    showDecomposition(startVal, changeVal, needToFill, remainderCount);
                    if (needToFill > 0 && remainderCount > 0) {
                        groupWaitingBees(needToFill, remainderCount);
                    } else {
                        els.waitingContainer.innerHTML = '';
                        for (let i = 0; i < changeVal; i++) { addWaitingBee(); }
                    }
                    els.waitingArea.classList.remove('hidden');

                    // Show Number Bond Panel for addition crossing 10
                    if (remainderCount > 0) {
                        const bondPanel = document.getElementById('number-bond-panel');
                        document.getElementById('bond-start').textContent = startVal;
                        document.getElementById('bond-change').textContent = changeVal;
                        document.getElementById('bond-fill-input').value = '';
                        document.getElementById('bond-remainder-input').value = '';
                        document.getElementById('bond-feedback').classList.add('hidden');
                        bondPanel.classList.remove('hidden');
                        decomposition = { fill: needToFill, remainder: remainderCount };
                    } else {
                        document.getElementById('number-bond-panel').classList.add('hidden');
                    }

                } else {
                    // SUBTRACTION LOGIC
                    // For subtraction crossing 10: e.g., 12 - 5 = 12 - 2 - 3 = 10 - 3 = 7
                    // First remove bees to get to 10, then need to "borrow" from tens

                    if (ones >= changeVal) {
                        // Simple subtraction - no borrowing needed
                        needToFill = changeVal; // bees to remove
                        remainderCount = 0;
                    } else {
                        // Needs borrowing! Remove what we have, then borrow
                        needToFill = ones; // First remove down to 0
                        remainderCount = changeVal - ones; // Then remove this many after borrowing
                    }

                    showSubtractionDecomposition(startVal, changeVal, needToFill, remainderCount);
                    els.waitingArea.classList.add('hidden'); // No waiting bees for subtraction
                    document.getElementById('number-bond-panel').classList.add('hidden');
                }

                calcTarget = changeVal;
                calcProgress = 0;
                cpaStep = 0;
                stepState = 'IDLE';
                document.getElementById('calc-setup').classList.add('hidden');
                document.getElementById('calc-action').classList.remove('hidden');
                updateStepUI();

            } else if (currentMode === 'quiz') {
                // BLIND MODE SETUP
                document.getElementById('tensRoom').style.visibility = 'hidden';
                document.getElementById('onesRoom').style.visibility = 'hidden';
                document.getElementById('controls-calc').style.opacity = '0';
                document.getElementById('controls-calc').style.pointerEvents = 'none';

                document.getElementById('quiz-interface').classList.remove('hidden');
                document.getElementById('result-interface').classList.add('hidden'); // Ensure result is hidden

                document.getElementById('quiz-question').innerHTML = `${startVal} ${currentOperator} ${changeVal} = ?`;
                quizCurrentInput = '';
                updateQuizInputDisplay();

                if (currentOperator === '+') {
                    friendsAnswer = startVal + changeVal;
                } else {
                    friendsAnswer = startVal - changeVal;
                }

                els.waitingContainer.innerHTML = '';
                els.waitingArea.classList.add('hidden');
            }
        }

        let quizCurrentInput = '';

        function quizInput(val) {
            if (val === 'back') {
                quizCurrentInput = quizCurrentInput.slice(0, -1);
            } else {
                if (quizCurrentInput.length < 2) {
                    quizCurrentInput += val;
                }
            }
            updateQuizInputDisplay();
        }

        function updateQuizInputDisplay() {
            const el = document.getElementById('quiz-input-display');
            el.innerText = quizCurrentInput === '' ? '?' : quizCurrentInput;
        }

        async function submitQuiz() {
            if (quizCurrentInput === '') return;
            const val = parseInt(quizCurrentInput);

            if (val === friendsAnswer) {
                // CORRECT
                document.getElementById('quiz-interface').classList.add('hidden');

                // SHOW NEW RESULT PAGE
                showResultPage(friendsAnswer);

            } else {
                // WRONG
                const box = document.getElementById('quiz-input-display');
                box.classList.add('shake-horizontal', 'bg-red-100', 'text-red-600', 'border-red-400');
                await sleep(500);
                box.classList.remove('shake-horizontal', 'bg-red-100', 'text-red-600', 'border-red-400');
                quizCurrentInput = '';
                updateQuizInputDisplay();
            }
        }

        function showResultPage(answer) {
            const resultIf = document.getElementById('result-interface');
            const resultNum = document.getElementById('result-number');
            const resultVisuals = document.getElementById('result-visuals');

            resultNum.innerText = answer;
            resultVisuals.innerHTML = '';

            // Calculate Hives and Bees
            const hives = Math.floor(answer / 10);
            const bees = answer % 10;

            // Add Hives
            for (let i = 0; i < hives; i++) {
                const h = document.createElement('div');
                h.className = 'transform scale-125 mx-2';
                h.style.width = '60px';
                h.style.height = '60px'; // Approx
                h.innerHTML = svgHive;
                resultVisuals.appendChild(h);
            }

            // Add Bees (grouped?)
            for (let i = 0; i < bees; i++) {
                const b = document.createElement('div');
                b.className = 'w-10 h-10 mx-0.5 animate-bounce';
                b.style.animationDelay = `${i * 0.1}s`;
                b.innerHTML = svgBeeStandard;
                resultVisuals.appendChild(b);
            }

            resultIf.classList.remove('hidden');
        }

        function showFloatingText(text, container, color = '#d97706') {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.style.color = color;
            el.innerText = text;
            el.style.top = '50%';
            el.style.left = '50%';
            el.style.transform = 'translate(-50%, -50%)';
            container.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        // === MILESTONE 5: Number Bond Verification ===
        function verifyNumberBond() {
            const fillInput = parseInt(document.getElementById('bond-fill-input').value) || 0;
            const remainderInput = parseInt(document.getElementById('bond-remainder-input').value) || 0;
            const feedback = document.getElementById('bond-feedback');

            if (!decomposition) return;

            const fillCorrect = fillInput === decomposition.fill;
            const remainderCorrect = remainderInput === decomposition.remainder;

            feedback.classList.remove('hidden');

            if (fillCorrect && remainderCorrect) {
                feedback.textContent = 'üéâ Â§™Ê£í‰∫Ü! ÊãÜÂàÜÊ≠£Á°Æ!';
                feedback.className = 'mt-2 text-center text-lg font-bold text-green-600';

                // Celebrate and allow animation to proceed
                document.getElementById('bond-fill-input').classList.add('border-green-600', 'bg-green-100');
                document.getElementById('bond-remainder-input').classList.add('border-green-600', 'bg-green-100');

                // Flash the waiting groups
                const fillGroup = els.waitingContainer.querySelector('.fill-group');
                const remGroup = els.waitingContainer.querySelector('.remainder-group');
                if (fillGroup) fillGroup.classList.add('celebrating');
                if (remGroup) remGroup.classList.add('celebrating');

                setTimeout(() => {
                    if (fillGroup) fillGroup.classList.remove('celebrating');
                    if (remGroup) remGroup.classList.remove('celebrating');
                }, 600);

            } else {
                feedback.textContent = 'ÂÜçÊÉ≥ÊÉ≥! ü§î';
                feedback.className = 'mt-2 text-center text-lg font-bold text-red-600';

                if (!fillCorrect) {
                    document.getElementById('bond-fill-input').classList.add('shake-horizontal', 'border-red-400');
                    setTimeout(() => document.getElementById('bond-fill-input').classList.remove('shake-horizontal', 'border-red-400'), 500);
                }
                if (!remainderCorrect) {
                    document.getElementById('bond-remainder-input').classList.add('shake-horizontal', 'border-red-400');
                    setTimeout(() => document.getElementById('bond-remainder-input').classList.remove('shake-horizontal', 'border-red-400'), 500);
                }
            }
        }

        function updateGlobalButtons() {
            const disabled = isAnimating;
            document.querySelectorAll('button').forEach(b => {
                if (!b.classList.contains('tab-btn') && !b.classList.contains('absolute') && !b.classList.contains('menu-btn')) {
                    b.disabled = disabled;
                }
            });
        }

        // === TEN FRIENDS GAME MODE ===

        function startFriendsPuzzle() {
            // Reset the ten frame
            ones = 0;
            tens = 0;
            initTenFrame();
            updateDisplay();

            // Generate random number of bees (0-9)
            const beeCount = Math.floor(Math.random() * 10); // 0 to 9
            friendsAnswer = 10 - beeCount;

            // Fill bees in ten frame
            for (let i = 0; i < beeCount; i++) {
                renderBeeInCell(i, 'standard');
                ones++;
            }
            updateDisplay();

            // Highlight empty slots (ghost bees already visible from initTenFrame)
            highlightEmptySlots();

            // Generate answer options
            generateFriendsOptions(friendsAnswer);

            // Update score display
            document.getElementById('friendsScoreDisplay').textContent = friendsScore;
        }

        function generateFriendsOptions(correctAnswer) {
            const optionsContainer = document.getElementById('friends-options');
            optionsContainer.innerHTML = '';

            // Create options array with correct answer and 2 distractors
            let options = [correctAnswer];

            // Generate distractors (avoid 0 if correct is not 0)
            const possibleDistractors = [];
            for (let i = 1; i <= 10; i++) {
                if (i !== correctAnswer) possibleDistractors.push(i);
            }

            // Shuffle and pick 2 distractors
            possibleDistractors.sort(() => Math.random() - 0.5);
            options.push(possibleDistractors[0]);
            options.push(possibleDistractors[1]);

            // Shuffle options
            options.sort(() => Math.random() - 0.5);

            // Option colors
            const colors = ['opt-cyan', 'opt-pink', 'opt-orange'];

            // Create shape block buttons
            options.forEach((num, idx) => {
                const block = document.createElement('button');

                // Determine grid layout based on count
                const cols = num <= 2 ? num : (num <= 4 ? 2 : (num <= 6 ? 3 : (num <= 8 ? 4 : 5)));
                block.className = `bee-shape-block shape-row-${cols} ${colors[idx]}`;
                block.onclick = () => checkFriendsAnswer(num, block);

                // Create mini-bees
                for (let b = 0; b < num; b++) {
                    const bee = document.createElement('div');
                    bee.className = 'mini-bee';
                    block.appendChild(bee);
                }

                optionsContainer.appendChild(block);
            });
        }

        async function checkFriendsAnswer(answer, btnEl) {
            if (isAnimating) return;

            if (answer === friendsAnswer) {
                // CORRECT!
                isAnimating = true;
                btnEl.classList.add('correct');

                // Disable all buttons
                document.querySelectorAll('.bee-shape-block').forEach(b => b.disabled = true);

                // Animate mini-bees flying out
                const miniBees = btnEl.querySelectorAll('.mini-bee');
                miniBees.forEach((bee, i) => {
                    setTimeout(() => {
                        bee.classList.add('flying-bee');
                    }, i * 80);
                });

                await sleep(miniBees.length * 80 + 400);

                // Fill remaining slots with animation
                clearHighlights();
                for (let i = ones; i < 10; i++) {
                    renderBeeInCell(i, 'added');
                    ones++;
                    updateDisplay();
                    await sleep(150);
                }

                // Celebration
                showStepMessage('üéâ Â§™Ê£í‰∫Ü! 10! üéâ', els.onesRoom, 1500);
                els.onesRoom.classList.add('celebrating');

                // Update score
                friendsScore++;
                document.getElementById('friendsScoreDisplay').textContent = friendsScore;

                await sleep(1500);
                els.onesRoom.classList.remove('celebrating');

                // Next puzzle
                isAnimating = false;
                startFriendsPuzzle();

            } else {
                // WRONG
                btnEl.classList.add('wrong');

                // Pulse the empty slots as hint
                highlightEmptySlots();
                showStepMessage(`ÂÜçÊÉ≥ÊÉ≥! ËøòÂ∑Æ ${friendsAnswer} Âè™!`, els.onesRoom, 1200);

                // Remove wrong class after animation
                setTimeout(() => {
                    btnEl.classList.remove('wrong');
                }, 500);
            }
        }
    </script>
</body>

</html>